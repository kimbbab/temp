<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ëª… ê°œì²™ì: ì¼ìƒ ì† í™•ë¥  ê²Œì„</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.7;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e; /* ì–´ë‘ìš´ ë‚¨ìƒ‰ ë°°ê²½ */
            color: #e0e0e0; /* ë°ì€ íšŒìƒ‰ í…ìŠ¤íŠ¸ */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .game-window { /* ì „ì²´ ê²Œì„ í™”ë©´ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
            width: 100%;
            max-width: 800px; /* ê²Œì„ í™”ë©´ ìµœëŒ€ ë„ˆë¹„ */
            height: 600px; /* ê²Œì„ í™”ë©´ ê³ ì • ë†’ì´ (ë¹„ì£¼ì–¼ ë…¸ë²¨ ëŠë‚Œ) */
            background-color: #24283b; /* ì‚´ì§ ë°ì€ ë‚¨ìƒ‰ */
            border: 2px solid #4a4e69;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            position: relative; /* ë‚´ë¶€ ìš”ì†Œ ì ˆëŒ€ ìœ„ì¹˜ ê¸°ì¤€ */
            overflow: hidden;
        }
        .stage-title-bar {
            background-color: rgba(0,0,0,0.5);
            color: #ffd700; /* ê¸ˆìƒ‰ ê³„ì—´ */
            padding: 10px 20px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #4a4e69;
        }

        .main-content-area { /* ìƒí™© í…ìŠ¤íŠ¸ ë“±ì´ í‘œì‹œë  ì£¼ ì˜ì—­ */
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; /* ë‚´ìš© ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ */
            background-color: rgba(0,0,0,0.2); /* ì•½ê°„ì˜ ë°°ê²½ êµ¬ë¶„ */
        }

        .interaction-panel { /* í•˜ë‹¨ í…ìŠ¤íŠ¸ ë°•ìŠ¤ ë° ì„ íƒì§€ ì˜ì—­ */
            background-color: rgba(10, 25, 47, 0.85); /* ë°˜íˆ¬ëª… ì–´ë‘ìš´ ë°°ê²½ */
            border-top: 2px solid #4a4e69;
            padding: 20px;
            min-height: 220px; /* ìµœì†Œ ë†’ì´ í™•ë³´ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .stage { /* ê°œë³„ ìŠ¤í…Œì´ì§€ ì»¨í…Œì´ë„ˆ (JSë¡œ í•˜ë‚˜ì”© ë³´ì´ê²Œ í•¨) */
            display: none; 
            width: 100%; height: 100%; /* game-windowë¥¼ ì±„ìš°ë„ë¡ */
            flex-direction: column;
        }
        .narrative-text p {
            margin-bottom: 12px;
            font-size: 1.1em;
            color: #f0f0f0;
        }
        .highlight-prob { 
            color: #ffab40; /* ì£¼í™©ìƒ‰ ê³„ì—´ ê°•ì¡° */
            font-weight: bold;
        }
        .choices { margin-bottom: 15px; }
        .choices button {
            display: block;
            width: calc(100% - 10px); /* ì–‘ìª½ ì—¬ë°± */
            padding: 12px 15px;
            margin: 8px 5px;
            background-color: #4a54e2; /* ì„ íƒì§€ ë²„íŠ¼ ìƒ‰ */
            color: white;
            border: 1px solid #6970ef;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            text-align: left;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .choices button:hover {
            background-color: #6970ef;
            transform: translateX(5px);
        }
        .choices button:disabled {
            background-color: #3a3f6b;
            color: #888;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }
        .choices button::before { /* ì„ íƒì§€ ì• ë™ê·¸ë¼ë¯¸ ì•„ì´ì½˜ í‰ë‚´ */
            content: 'â–¶ ';
            color: #ffd700;
            margin-right: 8px;
        }

        .outcome-area {
            margin-top: 15px;
            padding: 15px;
            background-color: rgba(0,0,0,0.4);
            border-left: 4px solid #ffd700; /* ê¸ˆìƒ‰ ê³„ì—´ */
            border-radius: 0 6px 6px 0;
            display: none; 
            color: #f0f0f0;
            min-height: 60px;
        }
        .outcome-area .probabilities, .outcome-area .actual-result {
            margin-bottom: 8px;
            font-size: 1em;
        }
        .outcome-area strong { color: #ffd700; }

        .outcome-text-good { color: #4caf50 !important; font-weight: bold; font-size: 1.1em; }
        .outcome-text-bad { color: #f44336 !important; font-weight: bold; font-size: 1.15em; }
        .outcome-text-neutral { color: #e0e0e0 !important; }

        .next-button {
            display: none; 
            width: auto; /* ìë™ ë„ˆë¹„ */
            padding: 10px 25px;
            margin-top: 15px;
            background-color: #ffd700; 
            color: #1c1e21; /* ì–´ë‘ìš´ í…ìŠ¤íŠ¸ */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            align-self: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
            transition: background-color 0.2s ease;
        }
        .next-button:hover {
            background-color: #ffc107;
        }
        #summaryStage .interaction-panel { /* ìš”ì•½ í™”ë©´ì€ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
             min-height: auto; max-height: 400px; overflow-y: auto;
        }
        #recapList li {
            background-color: rgba(20, 30, 50, 0.7);
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #ffd700;
            list-style-type: none;
            font-size: 0.95em;
        }
        #recapList li strong { color: #6970ef; display: block; margin-bottom: 5px; }
        #finalVerdict { color: #ffd700; font-weight: bold; text-align: center; margin-top: 15px;}

        .screen-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translateX(-2px); }
            20%, 80% { transform: translateX(3px); }
            30%, 50%, 70% { transform: translateX(-5px); }
            40%, 60% { transform: translateX(5px); }
        }
        /* ì‹œì‘ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #stage0 { text-align: center; justify-content: center; }
        #stage0 h2 { border-bottom: none; font-size: 1.8em; margin-bottom: 20px;}
        #stage0 p { font-size: 1.1em; margin-bottom: 30px; }
        #nameInputArea { margin: 20px auto; width: 80%; max-width: 350px; }
        #nameInputArea label { margin-bottom: 8px; font-weight: bold; color: #e0e0e0; display: block; }
        #playerNameInput {
            padding: 12px; border: 1px solid #4a4e69; border-radius: 6px;
            font-size: 1em; width: calc(100% - 26px); background-color: #1a1a2e; color: #e0e0e0;
        }
        #welcomeMessage {
            margin: 20px 0; padding: 12px; background-color: rgba(74, 84, 226, 0.3);
            border-left: 4px solid #4a54e2; color: #e0e0e0; font-weight: bold;
            border-radius: 0 6px 6px 0; text-align: center; font-size: 1.1em;
        }
        #submitNameButton { width: auto; padding: 12px 30px; background-color: #ffd700; color: #1c1e21;}
        #submitNameButton:hover { background-color: #ffc107;}


        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ì¡°ì • */
        @media (max-width: 800px) { /* game-window ë„ˆë¹„ì™€ ê°™ê±°ë‚˜ ì‘ì„ ë•Œ */
            body { padding: 0; align-items: stretch; } /* í™”ë©´ ê½‰ ì±„ìš°ë„ë¡ */
            .game-window {
                max-width: 100%;
                height: 100vh; /* ëª¨ë°”ì¼ì—ì„œ ì „ì²´ í™”ë©´ ë†’ì´ */
                border-radius: 0;
                border-left: none; border-right: none;
            }
        }
        @media (max-width: 600px) {
            .interaction-panel { padding: 15px; min-height: 200px; }
            .narrative-text p { font-size: 1em; }
            .choices button { font-size: 0.95em; padding: 10px; }
            .outcome-area { padding: 10px; min-height: 50px; }
            .outcome-area .probabilities, .outcome-area .actual-result { font-size: 0.95em; }
            .next-button { font-size: 0.95em; padding: 10px 20px; }
            .stage-title-bar { font-size: 1.1em; padding: 8px 15px;}
        }

    </style>
</head>
<body>
    <div class="game-window">
        <div id="stage0" class="stage">
            <h2>ê²Œì„ ì‹œì‘!</h2>
            <p>"í‰ë²”í•´ ë³´ì´ëŠ” ì˜¤ëŠ˜ í•˜ë£¨, í¬ê³  ì‘ì€ ì„ íƒë“¤ì´ ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.<br>ë‹¹ì‹ ì˜ ê²°ì •ê³¼ ì•½ê°„ì˜ í™•ë¥ ì´ ë§Œë“¤ì–´ë‚¼ í•˜ë£¨ëŠ” ì–´ë–¤ ëª¨ìŠµì¼ê¹Œ?"</p>
            <div id="nameInputArea">
                <label for="playerNameInput">ë‹¹ì‹ ì˜ ì´ë¦„ì€ ë¬´ì—‡ì…ë‹ˆê¹Œ?</label>
                <input type="text" id="playerNameInput" placeholder="ì—¬ê¸°ì— ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div id="welcomeMessage" style="display:none;"></div>
            <div class="choices">
                <button id="submitNameButton" onclick="submitNameAndStart()">ì´ë¦„ ì…ë ¥í•˜ê³  í•˜ë£¨ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>

        <div id="gameArea" class="stage" style="display:flex; flex-direction:column;">
            <div id="stageTitleDisplay" class="stage-title-bar"></div>
            <div class="main-content-area" id="mainContentArea">
                 <div class="narrative-text">
                    <div id="situationText"></div>
                    <div id="dilemmaText"></div>
                </div>
            </div>
            <div class="interaction-panel">
                <div class="choices" id="choicesContainer">
                    </div>
                <div class="outcome-area" id="currentOutcomeArea">
                    <p class="probabilities"><strong>í™•ë¥  ì •ë³´:</strong> <span id="currentProbs"></span></p>
                    <p class="actual-result"><strong>ì‹¤ì œ ê²°ê³¼:</strong> <span id="currentResult"></span></p>
                </div>
                <button class="next-button" id="gameNextButton">ë‹¤ìŒìœ¼ë¡œ</button>
            </div>
        </div>
        
        <div id="summaryStage" class="stage" style="flex-direction:column;">
            <div id="summaryTitle" class="stage-title-bar">ğŸ“œ ë‚˜ì˜ í•˜ë£¨ ì´ì•¼ê¸° ğŸ“œ</div>
            <div class="interaction-panel" id="summaryInteractionPanel" style="flex-grow:1; overflow-y:auto;">
                <div id="summaryContainer">
                    <h3>âœ¨ ë‚´ê°€ ê²½í—˜í•œ í•˜ë£¨ì˜ ìˆœê°„ë“¤ âœ¨</h3>
                    <ul id="recapList"></ul>
                    <hr>
                    <h3 id="finalVerdict"></h3>
                </div>
                <div class="choices">
                    <button onclick="restartGame()" style="background-color: #ffd700; color: #1c1e21;">ë‹¤ì‹œ í•˜ë£¨ë¥¼ ì‹œì‘í•˜ê¸°</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        let playerName = "ëª¨í—˜ê°€"; 
        let currentStageIndex = 0; // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì¸ë±ìŠ¤ (stages ë°°ì—´ ê¸°ì¤€)
        const storyLog = [];
        let rainPercentage = 0; 

        const probChocoSoldOut = 1/4;
        const probSaltSoldOut = 2/3;
        const typingSpeed = 25; 

        // --- ê²Œì„ ìŠ¤í…Œì´ì§€ ë°ì´í„° ---
        const stages = [
            { // Stage 1: ì •ìˆ˜ê¸°
                title: "1ï¸âƒ£ ë‹¨ê³„: ì •ìˆ˜ê¸°ì˜ ë„ì „ ğŸ’§",
                situation: "ëª©ì´ ë§ë¼ ì •ìˆ˜ê¸°ë¡œ í–¥í–ˆì§€ë§Œ, ì´ëŸ°! ë¬¼í†µì´ í…… ë¹„ì–´ìˆë‹¤. ë™ë£Œ/ì¹œêµ¬ë“¤ì€ ëª¨ë‘ ë°”ë¹  ë³´ì´ê³ , ì§€ê¸ˆ ë‹¹ì¥ ë¬¼ì„ ë§ˆì‹œë ¤ë©´ ë‚´ê°€ ì§ì ‘ ë¬¼í†µì„ êµì²´í•´ì•¼ í•  ê²ƒ ê°™ë‹¤.",
                dilemma: "ì´ ë¬´ê±°ìš´ ë¬¼í†µ, ë‚´ê°€ ê³¼ì—° ì‚¬ê³  ì—†ì´ ì˜ ê°ˆ ìˆ˜ ìˆì„ê¹Œ? <span class='highlight-prob'>(ë„ì „ ì‹œ ì„±ê³µ í™•ë¥ : ì•½ 66.7%)</span> ê´œíˆ í˜ë§Œ ì“°ê³  ë§ì‹ ë‹¹í•˜ëŠ” ê±° ì•„ë‹ˆì•¼?",
                choices: [
                    { text: "A. ì¢‹ì•„, í•œë²ˆ í•´ë³´ì! ë‚´ê°€ í•´ê²°í•œë‹¤!", key: 'A', shortDesc: "ë¬¼í†µ êµì²´ì— ë„ì „í•œë‹¤." },
                    { text: "B. ì•„ë‹ˆì•¼, ë„ˆë¬´ ë¬´ê±°ì›Œ ë³´ì—¬. ë‹¤ë¥¸ ì‚¬ëŒì„ ê¸°ë‹¤ë¦¬ì.", key: 'B', shortDesc: "ë¬¼í†µ êµì²´ë¥¼ í¬ê¸°í•œë‹¤." }
                ],
                handler: function(choiceKey) {
                    let probabilitiesText = ""; 
                    let outcomeText = ""; 
                    let outcomeSentiment = 'neutral';
                    if (choiceKey === 'B') { 
                        probabilitiesText = "ë„ì „í•˜ì§€ ì•Šê¸°ë¡œ ì„ íƒí•¨. (ë§Œì•½ ë„ì „í–ˆë‹¤ë©´ ì„±ê³µ í™•ë¥  ì•½ 66.7%)";
                        outcomeText = "ë¬¼í†µ êµì²´ë¥¼ í¬ê¸°í–ˆë‹¤. ê²°êµ­ ë‹¤ë¥¸ ì‚¬ëŒì´ êµì²´í•´ì£¼ê±°ë‚˜, ëª©ë§ˆë¦„ì„ ì°¸ì•„ì•¼ í–ˆë‹¤.";
                        outcomeSentiment = 'neutral';
                    } else { 
                        probabilitiesText = "ë„ì „ ì‹œ ì„±ê³µ í™•ë¥ : 2/3 (ì•½ 66.7%), ì‹¤íŒ¨ í™•ë¥ : 1/3 (ì•½ 33.3%)";
                        if (Math.random() < (2/3)) { 
                            outcomeText = "ì™„ë²½í•´! ë¬¼í†µì„ ëŠ¥ìˆ™í•˜ê²Œ êµì²´í–ˆë‹¤. ë™ë£Œ/ì¹œêµ¬ë“¤ì˜ ê°íƒ„ê³¼ ì„ ë§ì˜ ì‹œì„ ì„ í•œ ëª¸ì— ë°›ì•˜ë‹¤. ì—­ì‹œ ë‚œ ëª»í•˜ëŠ” ê²Œ ì—†ì§€!";
                            outcomeSentiment = 'good';
                        } else {
                            outcomeText = "ì´ëŸ°! ë¬¼í†µì„ ë“¤ë‹¤ê°€ ê·¸ë§Œ ì†ì´ ë¯¸ë„ëŸ¬ì ¸ ë¬¼ì„ ìŸê³  ë§ì•˜ë‹¤. ì˜·ë„ ì –ê³  ë°”ë‹¥ë„ ë¬¼ë°”ë‹¤ê°€ ë˜ì–´ ë‹¹í™©ìŠ¤ëŸ½ë‹¤. ê´œíˆ ë‚˜ì„°ë‚˜...";
                            outcomeSentiment = 'bad';
                        }
                    }
                    return { probabilitiesText, outcomeText, outcomeSentiment };
                }
            },
            { // Stage 2: ë™ì „ ë˜ì§€ê¸°
                title: "2ï¸âƒ£ ë‹¨ê³„: ë™ì „ì˜ ì–‘ë©´, ë‚´ê¸°ì˜ ìœ í˜¹ ğŸ’°",
                situation: "ì ì‹¬ì‹œê°„, ì¹œêµ¬ê°€ 100ì›ì„ ê±¸ê³  ì¬ë¯¸ìˆëŠ” ë‚´ê¸°ë¥¼ ì œì•ˆí•œë‹¤. \"ë™ì „ 2ê°œë¥¼ ë™ì‹œì— ë˜ì§ˆ ê±°ì•¼. ê²°ê³¼ë¥¼ ì •í™•íˆ ë§íˆë©´ ë‚´ê°€ 200ì› ì¤„ê²Œ! ì–´ë•Œ, í•´ë³¼ë˜?\" (ì°¸ê°€ë¹„ 100ì›)",
                dilemma: "í , 100ì›ìœ¼ë¡œ 200ì›ì„ ë”¸ ê¸°íšŒì¸ê°€, ì•„ë‹ˆë©´ 100ì›ì„ ë‚ ë¦´ í•¨ì •ì¸ê°€... ì–´ë–¤ ê²½ìš°ê°€ ê°€ì¥ í™•ë¥ ì´ ë†’ì„ê¹Œ?",
                choices: [
                    { text: "A. ì¢‹ì•„! ë‚œ ì•ë©´ 2ê°œì— ê±´ë‹¤!", key: 'A', shortDesc: "ì•ë©´ 2ê°œì— ê±´ë‹¤." },
                    { text: "B. ë‚´ ë¶„ì„ìœ¼ë¡œëŠ” ì•ë©´ 1ê°œ, ë’·ë©´ 1ê°œê°€ ê°€ì¥ ìœ ë ¥í•´!", key: 'B', shortDesc: "ì•ë©´ 1ê°œ, ë’·ë©´ 1ê°œì— ê±´ë‹¤." },
                    { text: "C. ì™ ì§€ ëŠë‚Œì´ ì•ˆ ì¢‹ì€ë°... ë‘˜ ë‹¤ ë’·ë©´ì´ ë‚˜ì˜¬ ê²ƒ ê°™ì•„!", key: 'C', shortDesc: "ë’·ë©´ 2ê°œì— ê±´ë‹¤." },
                    { text: "D. ì•ˆ í• ë˜. ë‚´ ì†Œì¤‘í•œ 100ì›ì€ ì§€ì¼œì•¼ì§€.", key: 'D', shortDesc: "ë‚´ê¸°ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤." }
                ],
                handler: function(choiceKey) {
                    let probabilitiesText = ""; let outcomeText = ""; let outcomeSentiment = 'neutral';
                    let coin1 = Math.random() < 0.5 ? 'ì•' : 'ë’¤'; let coin2 = Math.random() < 0.5 ? 'ì•' : 'ë’¤';
                    let actualCoinResult = "";
                    if (coin1 === 'ì•' && coin2 === 'ì•') actualCoinResult = 'AA';
                    else if (coin1 === 'ë’¤' && coin2 === 'ë’¤') actualCoinResult = 'TT';
                    else actualCoinResult = 'AT'; 
                    const actualResultText = (actualCoinResult === 'AA' ? 'ì•ë©´ 2ê°œ' : (actualCoinResult === 'TT' ? 'ë’·ë©´ 2ê°œ' : 'ì•ë©´ 1ê°œ, ë’·ë©´ 1ê°œ'));

                    if (choiceKey === 'D') {
                        probabilitiesText = "ë‚´ê¸°ë¥¼ í•˜ì§€ ì•Šì•„ ëˆì˜ ë³€í™”ëŠ” ì—†ìŒ.";
                        outcomeText = `ë‚´ê¸°ë¥¼ í•˜ì§€ ì•Šê¸°ë¡œ í–ˆë‹¤. 100ì›ì„ ì•„ê¼ˆìœ¼ë‹ˆ ì†í•´ëŠ” ì•„ë‹ˆì§€ë§Œ, ê²°ê³¼ëŠ” ê¶ê¸ˆí•˜ë„¤! (ì‹¤ì œ ë™ì „ ê²°ê³¼: ${actualResultText})`;
                    } else {
                        let predictedResultKey = "";
                        if (choiceKey === 'A') { probabilitiesText = "ë‚˜ì˜ ì„ íƒ: ì•ë©´ 2ê°œ. (ì´ ê²°ê³¼ê°€ ë‚˜ì˜¬ í™•ë¥ : 1/4 = 25%)"; predictedResultKey = 'AA'; }
                        else if (choiceKey === 'B') { probabilitiesText = "ë‚˜ì˜ ì„ íƒ: ì•ë©´ 1ê°œ, ë’·ë©´ 1ê°œ. (ì´ ê²°ê³¼ê°€ ë‚˜ì˜¬ í™•ë¥ : 2/4 = 50%)"; predictedResultKey = 'AT'; }
                        else { probabilitiesText = "ë‚˜ì˜ ì„ íƒ: ë’·ë©´ 2ê°œ. (ì´ ê²°ê³¼ê°€ ë‚˜ì˜¬ í™•ë¥ : 1/4 = 25%)"; predictedResultKey = 'TT';}

                        if (actualCoinResult === predictedResultKey) {
                            outcomeText = "ëŒ€ë°•! ì •í™•íˆ ë§í˜”ë‹¤! ì¹œêµ¬ì—ê²Œ 200ì›ì„ ë°›ì•„ 100ì› ì´ë“ì„ ë´¤ë‹¤. ì—­ì‹œ ë‚œ ì˜ˆì¸¡ì˜ ì‹ ì´ì•¼!"; outcomeSentiment = 'good';
                        } else {
                            outcomeText = `ì•„ì‰½ë„¤, ì˜ˆì¸¡ ì‹¤íŒ¨! ì°¸ê°€ë¹„ 100ì›ë§Œ ë‚ ë ¸ë‹¤. (ì‹¤ì œ ë™ì „ ê²°ê³¼: ${actualResultText})`; outcomeSentiment = 'bad';
                        }
                    }
                    return { probabilitiesText, outcomeText, outcomeSentiment };
                }
            },
            { // Stage 3: ë„ì„œê´€
                title: "3ï¸âƒ£ ë‹¨ê³„: ë„ì„œê´€ì—ì„œì˜ ê¸°ëŒ€ê° ğŸ“š",
                situation: "ì£¼ë§ ì˜¤í›„, ë„ì„œê´€ì— ê°€ì„œ ì±…ì„ ì½ì„ê¹Œ ê³ ë¯¼ ì¤‘ì´ë‹¤. ì–¼ë§ˆ ì „ ì¹œêµ¬ ìˆ˜ë¯¸ì™€ ì§€ì€ì´ë„ ì˜¤ëŠ˜ ë„ì„œê´€ì— ê°ˆ ìˆ˜ë„ ìˆë‹¤ê³  í–ˆë˜ ê¸°ì–µì´ ë‚œë‹¤. ë‘˜ ë‹¤ ë§Œë‚˜ë©´ ì •ë§ ì¢‹ì„ í…ë°!",
                dilemma: "<span class='highlight-prob'>ìˆ˜ë¯¸ê°€ ë„ì„œê´€ì— ì˜¬ í™•ë¥ ì€ 1/3 (ì•½ 33.3%)</span>, <span class='highlight-prob'>ì§€ì€ì´ê°€ ì˜¬ í™•ë¥ ì€ 2/3 (ì•½ 66.7%)</span>ë¼ê³  í•œë‹¤. ë‘˜ ë‹¤ ë§Œë‚  í™•ë¥ ì€ ì–¼ë§ˆë‚˜ ë ê¹Œ? ì•„ë‹ˆë©´ ê·¸ëƒ¥ ì§‘ì—ì„œ í¸í•˜ê²Œ ì‰´ê¹Œ?",
                choices: [
                    { text: "A. ì¢‹ì•„, ë„ì„œê´€ìœ¼ë¡œ ì¶œë°œ!", key: 'A', shortDesc: "ë„ì„œê´€ì— ê°„ë‹¤." },
                    { text: "B. ì˜¤ëŠ˜ì€ ê·¸ëƒ¥ ì§‘ì—ì„œ ì‰´ë˜.", key: 'B', shortDesc: "ë„ì„œê´€ì— ê°€ì§€ ì•Šê³  ì§‘ì—ì„œ ì‰°ë‹¤." }
                ],
                handler: function(choiceKey) {
                    let probabilitiesText = ""; let outcomeText = ""; let outcomeSentiment = 'neutral';
                    const probSumiYes = 1/3; const probSumiNo = 2/3;
                    const probJieunYes = 2/3; const probJieunNo = 1/3;
                    const probBoth = (probSumiYes * probJieunYes); 
                    const probSumiOnly = (probSumiYes * probJieunNo);
                    const probJieunOnly = (probSumiNo * probJieunYes); 
                    const probNeither = (probSumiNo * probJieunNo); 
                    
                    if (choiceKey === 'B') { 
                        probabilitiesText = `ë„ì„œê´€ì— ê°€ì§€ ì•Šê¸°ë¡œ ì„ íƒí•¨. (ì°¸ê³ : ìˆ˜ë¯¸ë§Œ ì˜¬ í™•ë¥  ì•½ ${Math.round(probSumiOnly*100)}%, ì§€ì€ì´ë§Œ ì˜¬ í™•ë¥  ì•½ ${Math.round(probJieunOnly*100)}%, ë‘˜ ë‹¤ ì˜¬ í™•ë¥  ì•½ ${Math.round(probBoth*100)}%)`;
                        outcomeText = "ì§‘ì—ì„œ í¸ì•ˆí•˜ê²Œ íœ´ì‹ì„ ì·¨í–ˆë‹¤. ë„ì„œê´€ì— ê°”ìœ¼ë©´ ëˆ„êµ¬ë¥¼ ë§Œë‚¬ì„ì§€ëŠ” ë¯¸ìŠ¤í„°ë¦¬ë¡œ ë‚¨ì•˜ë‹¤. ê°€ë”ì€ ì´ëŸ° ì—¬ìœ ë„ ì¢‹ì§€!";
                    } else { 
                        let sumiComes = Math.random() < probSumiYes;
                        let jieunComes = Math.random() < probJieunYes;
                        probabilitiesText = `ì„ íƒ: ë„ì„œê´€ì— ê°„ë‹¤. (ìˆ˜ë¯¸ ì˜¬ í™•ë¥ : 1/3, ì§€ì€ì´ ì˜¬ í™•ë¥ : 2/3). <br>ìƒì„¸ ê²°ê³¼ í™•ë¥ : ë‘˜ ë‹¤ ë§Œë‚¨(${Math.round(probBoth*100)}%), ìˆ˜ë¯¸ë§Œ(${Math.round(probSumiOnly*100)}%), ì§€ì€ì´ë§Œ(${Math.round(probJieunOnly*100)}%), ì•„ë¬´ë„ ëª» ë§Œë‚¨(${Math.round(probNeither*100)}%)`;
                        
                        if (sumiComes && jieunComes) { outcomeText = "ëŒ€ì„±ê³µ! ë„ì„œê´€ì— ê°”ë”ë‹ˆ ìˆ˜ë¯¸ì™€ ì§€ì€ì´ ë‘˜ ë‹¤ ì™€ ìˆì—ˆë‹¤! í•¨ê»˜ ê³µë¶€í•˜ê³  ì´ì•¼ê¸°ë„ ë‚˜ëˆ„ë©° ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ëƒˆë‹¤."; outcomeSentiment = 'good'; }
                        else if (sumiComes && !jieunComes) { outcomeText = "ë„ì„œê´€ì—ì„œ ìˆ˜ë¯¸ë¥¼ ë§Œë‚¬ë‹¤! ì§€ì€ì´ëŠ” ì•ˆ ì™”ì§€ë§Œ, ìˆ˜ë¯¸ì™€ ì˜¤ëœë§Œì— ì´ëŸ°ì €ëŸ° ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ´ë‹¤."; outcomeSentiment = 'good'; }
                        else if (!sumiComes && jieunComes) { outcomeText = "ë„ì„œê´€ì— ê°”ë”ë‹ˆ ì§€ì€ì´ê°€ ì™€ ìˆì—ˆë‹¤! ìˆ˜ë¯¸ëŠ” ëª» ë´¤ì§€ë§Œ, ì§€ì€ì´ì™€ í•¨ê»˜ ì§‘ì¤‘í•´ì„œ ê³µë¶€í–ˆë‹¤."; outcomeSentiment = 'good'; }
                        else { outcomeText = "ì•„ë¬´ë„ ì—†ë„¤... ê²°êµ­ ë„ì„œê´€ì—ì„œ í˜¼ì ê³µë¶€í•˜ë‹¤ ì™”ë‹¤. ê·¸ë˜ë„ ì¡°ìš©í•´ì„œ ì§‘ì¤‘ì€ ì˜ ëœ ê²ƒ ê°™ë‹¤."; }
                    }
                    return { probabilitiesText, outcomeText, outcomeSentiment };
                }
            },
            { // Stage 4: ìš°ì‚°
                title: "4ï¸âƒ£ ë‹¨ê³„: ë³€ë•ìŸì´ ë‚ ì”¨ì™€ ìš°ì‚° â˜”",
                situationDynamic: function() { return `ì™¸ì¶œ ì¤€ë¹„ë¥¼ ê±°ì˜ ë§ˆì³¤ëŠ”ë°, ì°½ë°– í•˜ëŠ˜ì´ ì‹¬ìƒì¹˜ ì•Šë‹¤. ì¼ê¸°ì˜ˆë³´ë¥¼ í™•ì¸í•˜ë‹ˆ ì˜¤ëŠ˜ ë¹„ê°€ ì˜¬ í™•ë¥ ì€ <strong class='highlight-prob'>${rainPercentage}%</strong>ë¼ê³  í•œë‹¤.`; },
                dilemmaDynamic: function() { return `ë¹„ ì˜¬ í™•ë¥ ì´ <span class='highlight-prob'>${rainPercentage}</span>%ë¼ë‹ˆ... ì •ë§ ì• ë§¤í•œê±¸. ìš°ì‚°ì„ ì±™ê²¨ì•¼ í•˜ë‚˜, ë§ì•„ì•¼ í•˜ë‚˜?`; },
                choices: [
                    { text: "A. ê°€ì ¸ê°„ë‹¤.", key: 'A', shortDesc: "ìš°ì‚°ì„ ê°€ì ¸ê°„ë‹¤." },
                    { text: "B. ì•ˆ ê°€ì ¸ê°„ë‹¤.", key: 'B', shortDesc: "ìš°ì‚°ì„ ì•ˆ ê°€ì ¸ê°„ë‹¤." }
                ],
                handler: function(choiceKey) {
                    let probabilitiesText = ""; let outcomeText = ""; let outcomeSentiment = 'neutral';
                    let itRains = Math.random() < (rainPercentage / 100);
                    probabilitiesText = `ì˜¤ëŠ˜ ë¹„ ì˜¬ ì‹¤ì œ í™•ë¥ : ${rainPercentage}%.`;
                    if (choiceKey === 'A') { 
                        if (itRains) { outcomeText = "ì—­ì‹œ ë‚´ íŒë‹¨ì´ ì˜³ì•˜ì–´! ìš°ì‚°ì„ ì±™ê²¨ì„œ ë¹„ë¥¼ í”¼í•  ìˆ˜ ìˆì—ˆë‹¤. ì¤€ë¹„ëœ ìì˜ ì—¬ìœ !"; outcomeSentiment = 'good'; }
                        else { outcomeText = "ê²°êµ­ ë¹„ëŠ” ì˜¤ì§€ ì•Šì•˜ë‹¤. ê·¸ëŸ°ë° ì´ëŸ°, ìš°ì‚°ì„ ì–´ë””ë‹¤ ë‘ê³  ì˜¨ ê±°ì§€? ê¹œë¹¡í•˜ê³  ì‹ë‹¹/ì¹´í˜ì— ë†“ê³  ì™€ì„œ ìƒì–´ë²„ë ¸ë‹¤. ê´œíˆ ë“¤ê³  ë‚˜ì™”ë‚˜..."; outcomeSentiment = 'bad';}
                    } else { 
                        if (itRains) { outcomeText = "ì´ëŸ´ ìˆ˜ê°€! ê°‘ìê¸° ìŸì•„ì§€ëŠ” ë¹„ì— ì«„ë”± ë§ì•˜ë‹¤. ì¤‘ìš”í•œ ì•½ì†ì¸ë° ìŠ¤íƒ€ì¼ ë‹¤ êµ¬ê²¼ë„¤. ê°ê¸° ê±¸ë¦´ ê²ƒ ê°™ì•„."; outcomeSentiment = 'bad'; }
                        else { outcomeText = "ì—­ì‹œ ë‚˜ì˜ ì„ íƒ! ë¹„ë„ ì•ˆ ì˜¤ê³  ê°€ë³ê²Œ ì™¸ì¶œí•´ì„œ ì •ë§ í¸í–ˆë‹¤. ìš´ì´ ì¢‹ì•˜ì–´!"; outcomeSentiment = 'good';}
                    }
                    return { probabilitiesText, outcomeText, outcomeSentiment };
                }
            },
            { // Stage 5: ìíŒê¸°
                title: "5ï¸âƒ£ ë‹¨ê³„: ìˆ˜ìƒí•œ ìíŒê¸°ì˜ ìœ í˜¹ âœ¨",
                situation: "ì²˜ìŒ ë³´ëŠ” ë™ë„¤ë¥¼ ê±·ë‹¤ê°€ ë…íŠ¹í•œ ë””ìì¸ì˜ ìíŒê¸°ë¥¼ ë°œê²¬í–ˆë‹¤. 'ìˆ˜ìˆ˜ê»˜ë¼ì˜ ë§›!' ë²„íŠ¼ì´ ìˆê³ , ê°€ê²©ì€ 500ì›. ìíŒê¸°ì—ëŠ” \"ì´ˆíŠ¹ê¸‰ ë ˆì–´í…œ ìŒë£Œ í™•ë¥  1/10! ê³ ê¸‰ ìŒë£Œ í™•ë¥  3/10! ì¼ë°˜ ìŒë£Œ í™•ë¥  6/10!\" ì´ë¼ê³  ë°˜ì§ì´ë©° ì í˜€ìˆë‹¤.",
                dilemma: "ì´ˆíŠ¹ê¸‰ ë ˆì–´í…œì´ë¼ë‹ˆ, ê¶ê¸ˆí•œë°? 500ì›ìœ¼ë¡œ ì¸ìƒ ìŒë£Œë¥¼ ë§Œë‚  ìˆ˜ë„ ìˆì–ì•„! í•˜ì§€ë§Œ ëŒ€ë¶€ë¶„ ì¼ë°˜ ìŒë£Œê°€ ë‚˜ì˜¤ê² ì§€?",
                choices: [
                    { text: "A. ì¸ìƒì€ í•œ ë°©! ìˆ˜ìˆ˜ê»˜ë¼ì˜ ë§›ì— ë„ì „í•œë‹¤!", key: 'A', shortDesc: "ìˆ˜ìˆ˜ê»˜ë¼ ìŒë£Œì— ë„ì „í•œë‹¤." },
                    { text: "B. ì•„ë‹ˆì•¼, 500ì›ì´ë©´ í™•ì‹¤í•œ í–‰ë³µì„ ì‚´ ìˆ˜ ìˆì§€. ì˜†ì— ìˆëŠ” ìµìˆ™í•œ ì£¼ìŠ¤ë‚˜ ë§ˆì‹œì.", key: 'B', shortDesc: "ì•ˆì „í•˜ê²Œ ë‹¤ë¥¸ ìŒë£Œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì•ˆ ë§ˆì‹ ë‹¤." }
                ],
                handler: function(choiceKey) {
                    let probabilitiesText = ""; let outcomeText = ""; let outcomeSentiment = 'neutral';
                    if (choiceKey === 'B') {
                        probabilitiesText = "ì•ˆì „í•œ ì„ íƒì„ í•¨. (ìˆ˜ìˆ˜ê»˜ë¼ ìŒë£ŒëŠ” ë ˆì–´í…œ 10%, ê³ ê¸‰ 30%, ì¼ë°˜ 60% í™•ë¥ )";
                        outcomeText = "ìˆ˜ìˆ˜ê»˜ë¼ ìíŒê¸°ëŠ” ê·¸ëƒ¥ ì§€ë‚˜ì³¤ë‹¤. ì–´ë–¤ ìŒë£Œê°€ ë‚˜ì™”ì„ì§€ëŠ” ëª¨ë¥´ê² ì§€ë§Œ, ë‚´ ëˆ 500ì›ì€ ì•ˆì „í•˜ê²Œ ì§€ì¼°ë‹¤. / ì˜†ì— ìˆëŠ” ì½œë¼ë¥¼ ë§ˆì…¨ë‹¤. ìµìˆ™í•œ ë§›ì´ ì—­ì‹œ ìµœê³ ë‹¤!";
                    } else { 
                        probabilitiesText = "ì„ íƒ: ìˆ˜ìˆ˜ê»˜ë¼ ìŒë£Œ! (ì´ˆíŠ¹ê¸‰ ë ˆì–´í…œ í™•ë¥ : 10%, ê³ ê¸‰ ìŒë£Œ í™•ë¥ : 30%, ì¼ë°˜ ìŒë£Œ í™•ë¥ : 60%)";
                        let rand = Math.random();
                        if (rand < 0.1) { outcomeText = "ëŒ€ë°•! ìíŒê¸°ì—ì„œ ì •ë§ í¬ê·€í•˜ê³  ë§›ìˆëŠ” 'ì´ˆíŠ¹ê¸‰ ë ˆì–´í…œ ìŒë£Œ'ê°€ ë‚˜ì™”ë‹¤! ì˜¤ëŠ˜ ë­”ê°€ ì¢‹ì€ ì¼ì´ ìƒê¸¸ ê²ƒ ê°™ì€ ì˜ˆê°ì´ ë“ ë‹¤. 500ì›ì˜ í–‰ë³µì´ ì´ëŸ° ê±´ê°€!"; outcomeSentiment = 'good';}
                        else if (rand < 0.1 + 0.3) { outcomeText = "ì˜¤! 'ê³ ê¸‰ ê³¼ì¼ ìŠ¤ë¬´ë””'ê°€ ë‚˜ì™”ë‹¤! ìƒê°ë³´ë‹¤ í›¨ì”¬ ê´œì°®ì€ë°? 500ì›ì´ ì•„ê¹ì§€ ì•Šì•„!"; outcomeSentiment = 'good';}
                        else { outcomeText = "ìŒ... ê·¸ëƒ¥ í‰ë²”í•œ ì˜¤ë Œì§€ ì£¼ìŠ¤ê°€ ë‚˜ì™”ë„¤. ë§›ì€ ìˆì§€ë§Œ, 'ìˆ˜ìˆ˜ê»˜ë¼'ëŠ” ì•„ë‹ˆì—ˆë‹¤. 500ì›ì´ ì¡°ê¸ˆ ì•„ê¹ê¸°ë„ í•˜ê³ .";}
                    }
                    return { probabilitiesText, outcomeText, outcomeSentiment };
                }
            },
            { // Stage 6: ë¹µì§‘
                title: "6ï¸âƒ£ ë‹¨ê³„: ë¹µì§‘ì˜ ìœ í˜¹ ğŸ¥ğŸ",
                situation: "í‡´ê·¼/í•˜êµê¸¸, ë™ë„¤ ë¹µì§‘ì— ë“¤ë¥¼ê¹Œ í•œë‹¤. ì¸ê¸° ë§ì€ ì´ˆì½”ë¹µê³¼ ì†Œê¸ˆë¹µì´ ì•„ì§ ë‚¨ì•„ìˆì„ê¹Œ? í•˜ë‚˜ë¼ë„ ë‚¨ì•„ìˆìœ¼ë©´ ì‚¬ì„œ ê°€ê³  ì‹¶ì€ë°...",
                dilemma: "<span class='highlight-prob'>ì´ˆì½”ë¹µì´ ì´ë¯¸ ë‹¤ íŒ”ë ¸ì„ í™•ë¥ ì€ 1/4 (25%)</span>, <span class='highlight-prob'>ì†Œê¸ˆë¹µì´ ì´ë¯¸ ë‹¤ íŒ”ë ¸ì„ í™•ë¥ ì€ 2/3 (ì•½ 66.7%)</span>ë¼ê³  í•œë‹¤. ë‘˜ ë‹¤ ì´ë¯¸ íŒ”ë ¸ìœ¼ë©´ ì–´ë–¡í•˜ì§€? í•˜ë‚˜ë¼ë„ ë‚¨ì•„ìˆìœ¼ë©´ ì¢‹ê² ëŠ”ë°...",
                choices: [
                    { text: "A. ê·¸ë˜ë„ ê°€ë³´ì! ë¹µì´ ë‚¨ì•„ìˆì„ì§€ë„ ëª°ë¼.", key: 'A', shortDesc: "ë¹µì§‘ì— ê°€ë³¸ë‹¤." },
                    { text: "B. ì´ë¯¸ ë‹¤ íŒ”ë ¸ì„ ê²ƒ ê°™ì•„. ê·¸ëƒ¥ ì§‘ì— ê°€ì.", key: 'B', shortDesc: "ë¹µì§‘ì— ê°€ì§€ ì•ŠëŠ”ë‹¤." }
                ],
                handler: function(choiceKey) {
                    let probabilitiesText = ""; let outcomeText = ""; let outcomeSentiment = 'neutral';
                    const probChocoNotSold = 1 - probChocoSoldOut; 
                    const probSaltNotSold = 1 - probSaltSoldOut;   
                    const probBothAvailable = (probChocoNotSold * probSaltNotSold); 
                    const probChocoOnlyAvailable = (probChocoNotSold * probSaltSoldOut);     
                    const probSaltOnlyAvailable = (probChocoSoldOut * probSaltNotSold);       
                    const probNeitherAvailable = (probChocoSoldOut * probSaltSoldOut); 
                                    
                    if (choiceKey === 'B') { 
                        probabilitiesText = `ë¹µì§‘ì— ê°€ì§€ ì•Šê¸°ë¡œ ê²°ì •. (ì°¸ê³ : ë‘˜ ë‹¤ ë‚¨ì•„ìˆì„ í™•ë¥  ì•½ ${Math.round(probBothAvailable*100)}%, í•˜ë‚˜ë¼ë„ ë‚¨ì•„ìˆì„ í™•ë¥  ì•½ ${Math.round((1-probNeitherAvailable)*100)}%)`;
                        outcomeText = "ë¹µì§‘ì— ê°€ì§€ ì•Šì•˜ìœ¼ë‹ˆ ë¹µì„ ì‚´ ê¸°íšŒëŠ” ì—†ì—ˆë‹¤. ì§‘ì— ì™€ì„œ ë‹¤ë¥¸ ê°„ì‹ì„ ì°¾ì•„ë´ì•¼ê² ë‹¤. (ë¹µì§‘ì— ê°”ë‹¤ë©´ ì–´ë–¤ ê²°ê³¼ì˜€ì„ê¹Œ?)";
                    } else { 
                        let chocobreadAvailable = Math.random() < probChocoNotSold;
                        let saltbreadAvailable = Math.random() < probSaltNotSold;
                        probabilitiesText = `ì„ íƒ: ë¹µì§‘ì— ê°„ë‹¤. (ì´ˆì½”ë¹µ ë‚¨ì„ í™•ë¥ : ${Math.round(probChocoNotSold*100)}%, ì†Œê¸ˆë¹µ ë‚¨ì„ í™•ë¥ : ${Math.round(probSaltNotSold*100)}%).<br> ìƒì„¸: ë‘˜ë‹¤O(${Math.round(probBothAvailable*100)}%), ì´ˆì½”ë§ŒO(${Math.round(probChocoOnlyAvailable*100)}%), ì†Œê¸ˆë§ŒO(${Math.round(probSaltOnlyAvailable*100)}%), ë‘˜ë‹¤X(${Math.round(probNeitherAvailable*100)}%)`;

                        if (chocobreadAvailable && saltbreadAvailable) { outcomeText = "ëŒ€ì„±ê³µ! ì´ˆì½”ë¹µê³¼ ì†Œê¸ˆë¹µ ë‘˜ ë‹¤ ë‚¨ì•„ìˆì—ˆë‹¤! í–‰ë³µí•œ ê³ ë¯¼ ëì— ë‘˜ ë‹¤ ì‚¬ë²„ë ¸ë‹¤."; outcomeSentiment = 'good';}
                        else if (chocobreadAvailable && !saltbreadAvailable) { outcomeText = "ë‹¤í–‰ì´ë‹¤! ì´ˆì½”ë¹µì€ ë‚¨ì•„ìˆì—ˆë‹¤. ì†Œê¸ˆë¹µì€ ì´ë¯¸ ë‹¤ íŒ”ë ¸ì§€ë§Œ, ì´ˆì½”ë¹µì´ë¼ë„ ì‚´ ìˆ˜ ìˆì–´ì„œ ê¸°ì˜ë‹¤."; outcomeSentiment = 'good';}
                        else if (!chocobreadAvailable && saltbreadAvailable) { outcomeText = "ì˜¤! ì†Œê¸ˆë¹µì´ ê¸°ì ì ìœ¼ë¡œ ë‚¨ì•„ìˆì—ˆë‹¤! ì´ˆì½”ë¹µì€ ì—†ì—ˆì§€ë§Œ, ì´ê²ƒë§Œìœ¼ë¡œë„ ë§Œì¡±ìŠ¤ëŸ½ë‹¤."; outcomeSentiment = 'good';}
                        else { outcomeText = "ì´ëŸ°... ì—­ì‹œ ëŠ¦ì—ˆë‚˜ ë³´ë‹¤. ì´ˆì½”ë¹µë„ ì†Œê¸ˆë¹µë„ ëª¨ë‘ ë‹¤ íŒ”ë¦¬ê³  ì—†ì—ˆë‹¤. ë¹ˆì†ìœ¼ë¡œ ëŒì•„ê°€ì•¼ í•˜ë‹¤ë‹ˆ..."; outcomeSentiment = 'bad';}
                    }
                    return { probabilitiesText, outcomeText, outcomeSentiment };
                }
            }
        ];

        // --- DOM ìš”ì†Œ ---
        const gameArea = document.getElementById('gameArea');
        const stageTitleDisplay = document.getElementById('stageTitleDisplay');
        const situationTextEl = document.getElementById('situationText');
        const dilemmaTextEl = document.getElementById('dilemmaText');
        const choicesContainer = document.getElementById('choicesContainer');
        const currentOutcomeArea = document.getElementById('currentOutcomeArea');
        const currentProbsEl = document.getElementById('currentProbs');
        const currentResultEl = document.getElementById('currentResult');
        const gameNextButton = document.getElementById('gameNextButton');

        function typewriter(element, text, callback, speed = typingSpeed) {
            if (!element) {
                if (callback) callback();
                return;
            }
            element.innerHTML = ""; 
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                } else {
                    if (callback) callback();
                }
            }
            type();
        }
        
        function triggerScreenShake() {
            const gameWindow = document.querySelector('.game-window');
            gameWindow.classList.add('screen-shake');
            setTimeout(() => {
                gameWindow.classList.remove('screen-shake');
            }, 400); 
        }

        function loadStage(stageIndex) {
            if (stageIndex >= stages.length) {
                showSummary();
                return;
            }
            currentStageIndex = stageIndex;
            const stageData = stages[stageIndex];

            showStage('gameArea'); // ê³µí†µ ê²Œì„ ì˜ì—­ í‘œì‹œ

            stageTitleDisplay.textContent = stageData.title;
            
            // situationê³¼ dilemma í…ìŠ¤íŠ¸ ì„¤ì • (íƒ€ì´í•‘ íš¨ê³¼ ì—†ì´ ì¦‰ì‹œ ë˜ëŠ” íƒ€ì´í•‘)
            // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì¦‰ì‹œ í‘œì‹œ
            let situationHTML = "";
            if (typeof stageData.situationDynamic === 'function') {
                situationHTML = stageData.situationDynamic();
            } else {
                situationHTML = stageData.situation;
            }
            situationTextEl.innerHTML = `<p>${situationHTML}</p>`; // HTMLë¡œ ì²˜ë¦¬

            let dilemmaHTML = "";
             if (typeof stageData.dilemmaDynamic === 'function') {
                dilemmaHTML = stageData.dilemmaDynamic();
            } else {
                dilemmaHTML = stageData.dilemma;
            }
            dilemmaTextEl.innerHTML = `<p>${dilemmaHTML}</p>`;


            choicesContainer.innerHTML = ''; // ì´ì „ ì„ íƒì§€ í´ë¦¬ì–´
            stageData.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.onclick = () => handleChoice(choice.key, choice.shortDesc);
                choicesContainer.appendChild(button);
            });

            currentOutcomeArea.style.display = 'none';
            gameNextButton.style.display = 'none';
            choicesContainer.style.display = 'block';
        }


        function showStage(stageIdToShow) { // ì´ í•¨ìˆ˜ëŠ” ì´ì œ div IDë¥¼ ì§ì ‘ ë°›ì•„ í™”ë©´ ì „í™˜ë§Œ ë‹´ë‹¹
            document.querySelectorAll('.stage').forEach(s => {
                s.style.display = 'none';
            });
            const stageElement = document.getElementById(stageIdToShow);
            if (stageElement) {
                stageElement.style.display = 'flex'; // gameArea ë“±ì€ flexë¡œ ì„¤ì •
                 if (stageIdToShow === 'stage0' || stageIdToShow === 'summaryStage') { // ì‹œì‘, ìš”ì•½ì€ block
                    stageElement.style.display = 'block';
                }
            }
        }
        
        function submitNameAndStart() {
            const nameInput = document.getElementById('playerNameInput');
            const welcomeDiv = document.getElementById('welcomeMessage');
            const nameInputAreaDiv = document.getElementById('nameInputArea');
            const submitBtn = document.getElementById('submitNameButton');
            
            if (nameInput.value.trim() !== "") {
                playerName = nameInput.value.trim();
            } else {
                playerName = "ëª¨í—˜ê°€"; 
            }

            if (nameInputAreaDiv) nameInputAreaDiv.style.display = 'none'; 
            if (submitBtn) submitBtn.style.display = 'none'; 

            welcomeDiv.style.display = 'block';
            typewriter(welcomeDiv, `${playerName}ë‹˜, ì¢‹ì€ ì´ë¦„ì´êµ°ìš”! ë‹¹ì‹ ì˜ ì„ íƒìœ¼ë¡œ ë©‹ì§„ í•˜ë£¨ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”!`, () => {
                setTimeout(() => {
                    startGameLogic(); 
                }, 1000); 
            });
        }

        function startGameLogic() { 
            storyLog.length = 0; 
            
            const welcomeDiv = document.getElementById('welcomeMessage');
            // nameInputAreaDiv ë“±ì€ restartGameì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” welcomeDivë§Œ ìˆ¨ê¹€
            if (welcomeDiv) welcomeDiv.style.display = 'none';

            rainPercentage = Math.floor(Math.random() * 61) + 20; 
            
            document.getElementById('summaryTitle').textContent = `ğŸ“œ ${playerName}ë‹˜ì˜ í•˜ë£¨ ì´ì•¼ê¸° ğŸ“œ`;
            
            loadStage(0); // ì²« ë²ˆì§¸ ìŠ¤í…Œì´ì§€ ë¡œë“œ (ì¸ë±ìŠ¤ 0)
        }
        
        function restartGame() {
            const nameInputAreaDiv = document.getElementById('nameInputArea');
            const nameInput = document.getElementById('playerNameInput');
            const welcomeDiv = document.getElementById('welcomeMessage');
            const submitBtn = document.getElementById('submitNameButton');

            if (nameInputAreaDiv) nameInputAreaDiv.style.display = 'block';
            if (nameInput) nameInput.value = ''; 
            if (welcomeDiv) welcomeDiv.style.display = 'none';
            if (submitBtn) submitBtn.style.display = 'block';

            showStage('stage0');
        }

        function addLog(stageTitle, choiceMade, probabilitiesShown, actualOutcome) {
            storyLog.push({ 
                stage: stageTitle, 
                choice: choiceMade, 
                probabilities: probabilitiesShown,
                outcome: actualOutcome 
            });
        }

        function handleChoice(choiceKey, choiceText) { // choiceTextëŠ” shortDesc
            const stageData = stages[currentStageIndex];
            const result = stageData.handler(choiceKey); // ê° ìŠ¤í…Œì´ì§€ í•¸ë“¤ëŸ¬ í˜¸ì¶œ

            addLog(stageData.title, choiceText, result.probabilitiesText, result.outcomeText);

            // ì„ íƒ ë²„íŠ¼ ë¹„í™œì„±í™”/ìˆ¨ê¸°ê¸°
            choicesContainer.style.display = 'none'; // ì„ íƒì§€ ì „ì²´ë¥¼ ìˆ¨ê¹€
            
            // í™•ë¥  ì •ë³´ ì¦‰ì‹œ í‘œì‹œ
            currentProbsEl.innerHTML = result.probabilitiesText;
            currentResultEl.className = ''; // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            currentResultEl.classList.add('outcome-text-' + result.outcomeSentiment);

            // ê²°ê³¼ í…ìŠ¤íŠ¸ íƒ€ì´í•‘ íš¨ê³¼ ë° ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
            currentOutcomeArea.style.display = 'block';
            typewriter(currentResultEl, result.outcomeText, () => {
                 gameNextButton.style.display = 'block';
                 if (result.outcomeSentiment === 'bad') {
                    triggerScreenShake();
                }
            });
        }

        gameNextButton.onclick = function() {
            loadStage(currentStageIndex + 1);
        };


        function showSummary() {
            showStage('summaryStage'); // ìš”ì•½ ìŠ¤í…Œì´ì§€ divë¥¼ ë³´ì´ê²Œ í•¨
            const recapListEl = document.getElementById('recapList');
            recapListEl.innerHTML = ""; 

            let overallFeeling = "ì˜¤ëŠ˜ì€ ì •ë§ ë‹¤ì´ë‚˜ë¯¹í•œ í•˜ë£¨ì˜€ë‹¤!"; 

            storyLog.forEach(log => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${log.stage}</strong><br>
                                      <span style="color:#555;">ë‚˜ì˜ ì„ íƒ: ${log.choice}</span><br>
                                      <em>(ë‹¹ì‹œ ì œì‹œëœ í™•ë¥  ì •ë³´: ${log.probabilities})</em><br>
                                      <span style="color: #1c1e21;">ì‹¤ì œ ê²°ê³¼: ${log.outcome}</span>`;
                recapListEl.appendChild(listItem);
            });
            
            let goodOutcomes = 0;
            storyLog.forEach(log => {
                // ê¸ì •ì  ê²°ê³¼ í‚¤ì›Œë“œ í™•ì¥
                if (log.outcome.includes("ì„±ê³µ") || log.outcome.includes("ì´ë“") || log.outcome.includes("ë§Œë‚¬ë‹¤") || log.outcome.includes("í”¼í•  ìˆ˜ ìˆì—ˆë‹¤") || log.outcome.includes("í¸í–ˆë‹¤") || log.outcome.includes("ë ˆì–´í…œ") || log.outcome.includes("ê³ ê¸‰") || log.outcome.includes("ë‚¨ì•„ìˆì—ˆë‹¤") || log.outcome.includes("ê±´ì¡Œë„¤") || log.outcome.includes("ì •í™•íˆ ë§í˜”ë‹¤") || log.outcome.includes("ì„ ë§ì˜ ì‹œì„ ") || log.outcome.includes("ê¸°ë¶„ ì¢‹ì€")) {
                    goodOutcomes++;
                }
            });

            if (storyLog.length > 0) { 
                if (goodOutcomes >= storyLog.length * 0.6) { 
                    overallFeeling = `ì˜¤ëŠ˜ì€ ${playerName}ë‹˜ì—ê²Œ ìš´ì´ ê½¤ ë”°ëë˜ ë©‹ì§„ í•˜ë£¨ì˜€ë‹¤! ì„ íƒë“¤ì´ ëŒ€ë¶€ë¶„ ì¢‹ì€ ê²°ê³¼ë¡œ ì´ì–´ì¡Œë„¤!`;
                } else if (goodOutcomes <= storyLog.length * 0.3) { 
                    overallFeeling = `ì˜¤ëŠ˜ì€ ${playerName}ë‹˜ì—ê²Œ ì¡°ê¸ˆ ì•„ì‰¬ìš´ ì„ íƒì´ ë§ì•˜ë˜ ê²ƒ ê°™ë‹¤. í•˜ì§€ë§Œ ëª¨ë“  ê²½í—˜ì—ì„œ ë°°ìš°ëŠ” ê±°ë‹ˆê¹Œ! ë‹¤ìŒì—” ë” ì¢‹ì€ ê²°ê³¼ê°€ ìˆê¸°ë¥¼!`;
                } else {
                    overallFeeling = `ì˜¤ëŠ˜ì€ ${playerName}ë‹˜ì—ê²Œ ê¸°ë¶„ ì¢‹ì€ ì¼ë„, ì•„ì‰¬ìš´ ì¼ë„ ìˆì—ˆë˜ í‰ë²”í•˜ì§€ë§Œ íŠ¹ë³„í•œ í•˜ë£¨ì˜€ë‹¤. ë‚´ì¼ì€ ë˜ ì–´ë–¤ ì¼ë“¤ì´ í¼ì³ì§ˆê¹Œ?`;
                }
            }

            document.getElementById('finalVerdict').textContent = "ì´í‰: " + overallFeeling;
        }

        // ì´ˆê¸° í™”ë©´ í‘œì‹œ
        showStage('stage0');
    </script>
</body>
</html>