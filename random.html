<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>확률 의사결정 게임</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .game-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .game-screen {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .game-screen.active {
            display: block;
        }
        .screen-title {
            font-size: 1.5em;
            color: #007bff;
            margin-bottom: 5px;
        }
        .location {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }
        .situation, .dilemma {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .choices button, .feedback-actions button {
            display: inline-block; 
            width: auto; 
            padding: 10px 15px; 
            margin: 5px; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .choices button.full-width { 
            display: block;
            width: 100%;
        }
        .choices button:hover, .feedback-actions button:hover {
            background-color: #0056b3;
        }
        .choices button:disabled, .feedback-actions button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .player-thought {
            font-style: italic;
            color: #555;
            margin-top: 10px;
            padding: 8px;
            background-color: #e9e9e9;
            border-radius: 3px;
        }
        .immediate-feedback {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }
        .immediate-feedback h4 {
            margin-top: 0;
            color: #0056b3;
        }
        .next-button { 
            display: none; 
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .next-button:hover {
            background-color: #218838;
        }
        #endingScreen .ending-text {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4caf50;
        }
        .highlight {
            font-weight: bold;
            color: #d9534f;
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1>나의 선택은?</h1>

    <div id="screen1" class="game-screen active">
        <h2 class="screen-title">선택 1: 아침, 우산과의 눈치 싸움</h2>
        <p class="location">📍 장소: 아침, 현관 앞</p>
        <p class="situation">
            TV에서 아나운서의 목소리가 흘러나온다.<br>
            "오늘 전국적으로 비 소식이 있습니다. 현재 예상 강수 확률은 <span id="rainChance" class="highlight">[xx]</span>%입니다."<br>
            창밖을 보니 하늘은 아직 흐리기만 하다.
        </p>
        <p class="dilemma">🤔 당신의 고민: 우산을 가져갈까, 말까?</p>
        <div class="choices">
            <button class="full-width" id="s1c1" onclick="handleChoice('screen1', 'A')">A) 혹시 모르니, 챙겨 나간다.</button>
            <button class="full-width" id="s1c2" onclick="handleChoice('screen1', 'B')">B) 이 정도 확률이면 괜찮아, 그냥 나간다.</button>
        </div>
        <div class="immediate-feedback" id="feedback1"></div>
        <button class="next-button" id="nextBtn1" onclick="proceedToNext(1)">다음으로</button>
    </div>

    <div id="screen2" class="game-screen">
        <h2 class="screen-title">선택 2: 길가의 유혹, 10%의 도전</h2>
        <p class="location">📍 장소: 등굣길, 문구점 앞</p>
        <p class="situation">
            등굣길, 문구점 앞에 놓인 상품 뽑기 기계가 시선을 사로잡는다.<br>
            "✨인기 캐릭터 한정판 인형 획득 찬스!✨ 단돈 100원! 성공 확률 <span class="highlight">10%</span>!"<br>
            (현재 내 지갑에는 <span id="currentMoneyLottery" class="highlight">[현재 소지금]</span>원이 있다.)
        </p>
        <p class="dilemma">🤔 당신의 고민: 10%의 확률... 한번 도전해 볼까?</p>
        <div class="player-thought">"10%면... 열 번 중 한 번은 되지 않을까?" (내적 고민)</div>
        <div class="choices" id="choices2_initial">
            <button class="full-width" id="s2c1_initial" onclick="handleLotteryChoice('initial_try')">A) 좋아, 10%의 행운에 도전한다! (100원 차감)</button>
            <button class="full-width" id="s2c2_initial" onclick="handleLotteryChoice('initial_pass')">B) 으음... 그래도 실패할 것 같아. 그냥 지나가자.</button>
        </div>
        <div class="immediate-feedback" id="feedback2">
            </div>
        <button class="next-button" id="nextBtn2" onclick="proceedToNext(2)" style="display:none;">다음 화면으로</button>
    </div>

    <div id="screen3" class="game-screen">
        <h2 class="screen-title">선택 3: 지각 위기! 정문 vs 후문</h2>
        <p class="location">📍 장소: 아슬아슬 등굣길, 학교 앞</p>
        <p class="situation">
            이런, 늦잠이다! 허겁지겁 학교 앞에 도착하니 이미 수업 시작 종이 울린 것 같다.<br>
            정문으로 당당히 들어갈까, 아니면 후문으로 몰래 들어갈까?<br>
            오늘은 유난히 선생님들이 지각생을 잡을 것 같은 불길한 예감이 스친다.<br>
            (교장 선생님의 특별 지시로, 오늘 정문과 후문 중 <span class="highlight">한 곳에서만</span> 선생님이 지각 단속을 하신다!)
        </p>
        <p class="dilemma">🤔 당신의 고민: 어느 문으로 들어가야 무사할까? 나의 선택은?</p>
        <div class="choices">
            <button class="full-width" id="s3c1" onclick="handleChoice('screen3', 'A')">A) 정면 돌파! 정문으로 가자!</button>
            <button class="full-width" id="s3c2" onclick="handleChoice('screen3', 'B')">B) 은밀하게... 후문으로 가자.</button>
        </div>
        <div class="immediate-feedback" id="feedback3"></div>
        <button class="next-button" id="nextBtn3" onclick="proceedToNext(3)">다음으로</button>
    </div>

    <div id="screen4" class="game-screen">
        <h2 class="screen-title">선택 4: 시험 시간, 마지막 한 문제</h2>
        <p class="location">📍 장소: 시험 시간 - 교실</p>
        <p class="situation">
            시험 종료 5분 전. 마지막 문제를 붙잡고 있지만... 아, 도저히 모르겠다!<br>
            하지만 포기할 순 없지. 답은 4개의 선택지 중 하나!
        </p>
        <p class="dilemma">🤔 당신의 고민: 어떤 번호로 찍어야 할까? 나의 직감을 믿어보자!</p>
        <div class="choices">
            <button class="full-width" id="s4c1" onclick="handleChoice('screen4', 'A')">A) 왠지 느낌이 오는 1번!</button>
            <button class="full-width" id="s4c2" onclick="handleChoice('screen4', 'B')">B) 가장 안 나올 것 같은 2번!</button>
            <button class="full-width" id="s4c3" onclick="handleChoice('screen4', 'C')">C) 나의 행운의 숫자 3번!</button>
            <button class="full-width" id="s4c4" onclick="handleChoice('screen4', 'D')">D) 모르겠을 땐 마지막 번호 4번!</button>
        </div>
        <div class="immediate-feedback" id="feedback4"></div>
        <button class="next-button" id="nextBtn4" onclick="proceedToNext(4)">다음으로</button>
    </div>

    <div id="screen5" class="game-screen">
        <h2 class="screen-title">선택 5: 빵집의 운명, 마지막 초코 크림빵</h2>
        <p class="location">📍 장소: 동네 빵집</p>
        <p class="situation">
            내가 제일 좋아하는 초코 크림빵을 사러 빵집에 왔다.<br>
            그런데... 내 앞에 이미 두 명이 줄을 서 있고, 진열대에는 초코 크림빵이 <span class="highlight">딱 한 개</span> 남아있다!<br>
            앞 사람들은 빵을 하나씩만 살 예정이고, 각자 이 초코 크림빵을 고를 확률은 <span class="highlight">50%</span>라고 한다.
        </p>
        <p class="dilemma">🤔 당신의 고민: 이 줄, 계속 서야 할까? 아니면 다른 빵을 찾아 떠날까?</p>
        <div class="choices">
            <button class="full-width" id="s5c1" onclick="handleChoice('screen5', 'A')">A) 마지막 희망을 걸고 기다려본다!</button>
            <button class="full-width" id="s5c2" onclick="handleChoice('screen5', 'B')">B) 이건 확률이 너무 낮아... 포기하고 다른 빵집에 가보자.</button>
        </div>
        <div class="immediate-feedback" id="feedback5"></div>
        <button class="next-button" id="nextBtn5" onclick="proceedToNext(5)">다음으로</button>
    </div>

    <div id="screen6" class="game-screen">
        <h2 class="screen-title">선택 6: 도서관에서 만날 확률은?</h2>
        <p class="location">📍 장소: 주말 오후, 나의 방</p>
        <p class="situation">
            주말 오후, 딱히 할 일이 떠오르지 않는다.<br>
            도서관에 가면 혹시 친구들을 만날 수 있을지도 모른다.<br>
            수미가 오늘 도서관에 올 확률은 <span class="highlight">50%(1/2)</span>, 지은이가 올 확률은 약 <span class="highlight">33%(1/3)</span>이라고 한다.<br>
            둘 다 만나면 심심하지 않고 정말 좋을 텐데...
        </p>
        <p class="dilemma">🤔 당신의 고민: 도서관에 가 볼까?</p>
        <div class="choices">
            <button class="full-width" id="s6c1" onclick="handleChoice('screen6', 'A')">A) 그래, 혹시 모르니 가서 친구들을 기다려보자!</button>
            <button class="full-width" id="s6c2" onclick="handleChoice('screen6', 'B')">B) 음... 둘 다 못 만날 수도 있으니 그냥 오늘은 집에 있자.</button>
        </div>
        <div class="immediate-feedback" id="feedback6"></div>
        <button class="next-button" id="nextBtn6" onclick="proceedToNext(6)">다음으로</button>
    </div>

    <div id="endingScreen" class="game-screen">
        <h2 class="screen-title">나의 하루 돌아보기</h2>
        <div id="endingTextOutput" class="ending-text">
            <p>나의 선택들이 모여 이런 하루가 되었어요...</p>
        </div>
        <div class="choices">
            <button class="full-width" onclick="restartGame()">다시 시작하기</button>
        </div>
    </div>
</div>

<script>
    let currentScreenNum = 1;
    let money = 1000;
    const chocoBreadPrice = 1000;
    let rainChancePercentage = 0;
    let endingTexts = [];
    let playerStats = {
        hasUmbrella: false,
        lotteryPrize: false,
        lotteryAttempts: 0,
        lotterySpent: 0,
        gotChocoBread: false,
        latePenalty: false,
        quizCorrect: false
    };

    function initializeGame() {
        rainChancePercentage = Math.floor(Math.random() * 81) + 10;
        document.getElementById('rainChance').textContent = rainChancePercentage;
        updateMoneyDisplay();
        for (let i = 1; i <= 6; i++) {
            disableChoiceButtons('screen' + i, false);
            const feedbackDiv = document.getElementById('feedback' + i);
            const nextButton = document.getElementById('nextBtn' + i);
            if(feedbackDiv) feedbackDiv.innerHTML = "";
            if(nextButton) nextButton.style.display = 'none';
        }
        const choices2Initial = document.getElementById('choices2_initial');
        if(choices2Initial) choices2Initial.style.display = 'block';
        showScreen(currentScreenNum);
    }

    function showScreen(screenNumber) {
        document.querySelectorAll('.game-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        const targetScreen = document.getElementById(screenNumber === 'Ending' ? 'endingScreen' : 'screen' + screenNumber);
        if(targetScreen) {
            targetScreen.classList.add('active');
        }
    }

    function updateMoneyDisplay() {
        const moneyDisplayLottery = document.getElementById('currentMoneyLottery');
        if (moneyDisplayLottery) moneyDisplayLottery.textContent = money;
    }

    function disableChoiceButtons(screenIdOrNum, disable = true) {
        const screenId = (typeof screenIdOrNum === 'string') ? screenIdOrNum : 'screen' + screenIdOrNum;
        const screen = document.getElementById(screenId);
        if (screen) {
            const choiceDiv = screen.querySelector('.choices'); 
            if(choiceDiv) {
                choiceDiv.querySelectorAll('button').forEach(button => {
                    button.disabled = disable;
                });
            }
            if (screenId === 'screen2') {
                const initialChoices2 = document.getElementById('choices2_initial');
                if (initialChoices2) {
                    initialChoices2.querySelectorAll('button').forEach(button => {
                        button.disabled = disable;
                    });
                }
            }
        }
    }

    function showNextButton(screenNum, show = true) {
         const nextButton = document.getElementById('nextBtn' + screenNum);
         if(nextButton) {
            nextButton.style.display = show ? 'block' : 'none';
         }
    }

    function displayImmediateFeedback(screenNum, feedbackHtml, showMainNextBtn = false) {
        const feedbackDiv = document.getElementById('feedback' + screenNum);
        if(feedbackDiv){
            feedbackDiv.innerHTML = feedbackHtml;
        }
        // 화면 2의 초기 버튼은 handleLotteryChoice에서 별도 관리하므로, 여기서는 일반적인 경우만 처리
        if (screenNum !== 2) {
            disableChoiceButtons(screenNum, true);
        }
        if(showMainNextBtn) {
             showNextButton(screenNum, true);
        }
    }

    function handleLotteryChoice(action) {
        const feedbackDiv = document.getElementById('feedback2');
        const initialChoicesDiv = document.getElementById('choices2_initial');
        const mainNextButton = document.getElementById('nextBtn2');
        let feedbackHtml = "";

        if(initialChoicesDiv) initialChoicesDiv.style.display = 'none';
        mainNextButton.style.display = 'none';

        if (action === 'initial_pass') {
            feedbackHtml = "<h4>결과: 도전 포기</h4><p>성공 확률 10%는 여전히 낮다고 판단하여, 신중하게 돈을 아끼기로 결정했습니다.</p>";
            endingTexts.push("[10%의 뽑기 확률 앞에서 도전을 포기하고 돈을 아꼈다.]");
            feedbackDiv.innerHTML = feedbackHtml;
            showNextButton(2, true); 
        } else if (action === 'initial_try' || action === 'retry') {
            if (money >= 100) {
                money -= 100;
                playerStats.lotteryAttempts++;
                playerStats.lotterySpent += 100;
                updateMoneyDisplay();
                let success = Math.random() < 0.10; // *** 뽑기 성공 확률 10%로 변경 ***

                if (success) {
                    playerStats.lotteryPrize = true;
                    feedbackHtml = `<h4>결과: 🎉 대성공! (${playerStats.lotteryAttempts}번째 시도) 🎉</h4><p>상품 뽑기 성공 확률 <span class="highlight">10%</span>에 도전하여, 드디어 상품을 뽑았습니다! 총 ${playerStats.lotterySpent}원을 사용했습니다.</p>`;
                    feedbackDiv.innerHTML = feedbackHtml;
                    showNextButton(2, true); 
                } else {
                    feedbackHtml = `<h4>결과: 꽝! (시도 횟수: ${playerStats.lotteryAttempts}, 남은 돈: ${money}원)</h4><p>상품 뽑기 성공 확률 <span class="highlight">10%</span>에 도전했지만, 아쉽게도 90%의 실패 확률이 더 높았네요. 100원을 잃었습니다.</p>`;
                    if (money >= 100) {
                        feedbackHtml += `<div class="feedback-actions"><button onclick="handleLotteryChoice('retry')">다시 도전한다! (100원 사용)</button> <button onclick="quitLotteryAndProceed()">그만하고 다음으로 넘어간다.</button></div>`;
                    } else {
                        feedbackHtml += "<p>돈이 부족하여 더 이상 도전할 수 없습니다.</p>";
                        feedbackHtml += `<div class="feedback-actions"><button onclick="quitLotteryAndProceed()">다음으로 넘어간다.</button></div>`;
                    }
                    feedbackDiv.innerHTML = feedbackHtml;
                }
            } else {
                feedbackHtml = "<h4>결과: 시도 실패!</h4><p>뽑기에 도전하고 싶었지만, 아쉽게도 돈이 부족해서 시도조차 못했습니다.</p>";
                feedbackDiv.innerHTML = feedbackHtml;
                showNextButton(2, true); 
            }
        }
    }

    function quitLotteryAndProceed() {
        proceedToNext(2);
    }

    function handleChoice(screenId, choice) {
        const screenNum = parseInt(screenId.replace('screen', ''));
        if (screenNum === 2) { 
            handleLotteryChoice(choice === 'A' ? 'initial_try' : 'initial_pass');
            return;
        }

        let feedbackHtml = "";
        let endingText = "";
        let showMainNextBtn = true;

        if (screenNum === 1) {
            let actuallyRained = Math.random() * 100 < rainChancePercentage;
            feedbackHtml += `<h4>결과: ${actuallyRained ? "비가 실제로 내렸습니다!" : "오늘은 비가 오지 않았습니다!"}</h4>`;
            feedbackHtml += `<p>오늘 비 올 확률은 ${rainChancePercentage}%였습니다. 이 확률에 따라 날씨가 결정되었어요.</p>`;

            if (choice === 'A') {
                playerStats.hasUmbrella = true;
                endingText = actuallyRained ? "[비 오는 날, 우산을 챙겨간 덕분에 보송보송하게 하루를 보냈다.]" : "[맑은 날, 혹시나 해서 챙겼던 우산이 조금 무거웠지만 그래도 안심이었다.]";
                feedbackHtml += `<p>당신은 우산을 챙겼습니다. ${actuallyRained ? "현명한 선택이었네요!" : "조금 번거로웠을 수도 있지만, 대비는 좋은 거죠!"}</p>`;
            } else { 
                playerStats.hasUmbrella = false;
                endingText = actuallyRained ? "[비 오는 날, 우산을 안 가져가서 결국 예상치 못한 비에 쫄딱 젖고 말았다.]" : "[맑은 날, 우산을 안 가져간 나의 가벼운 발걸음은 탁월한 선택이었다!]";
                feedbackHtml += `<p>당신은 우산을 챙기지 않았습니다. ${actuallyRained ? "이런! 비를 맞게 되었네요." : "예측 성공! 가뿐한 하루!"}</p>`;
            }
        }
        else if (screenNum === 3) { 
            let teacherAtMainGate = Math.random() < 0.5; 
            let caught = false;
            feedbackHtml += `<h4>결과: 선생님은... ${teacherAtMainGate ? "정문" : "후문"}에 계셨습니다!</h4><p>(각 문에 선생님이 계실 확률은 50%였습니다.)</p>`;

            if (choice === 'A') { 
                if (teacherAtMainGate) {
                    caught = true;
                    endingText = "[지각해서 정문으로 들어갔지만, 결국 선생님께 붙잡혀 따끔한 훈계를 들어야 했다.]";
                    feedbackHtml += "<p>이런! 정문으로 들어갔다가 단속에 걸렸습니다!</p>";
                } else {
                    endingText = "[지각했지만 정문으로 향했고, 다행히 선생님이 안 계셔서 무사히 교실로 들어갔다!]";
                    feedbackHtml += "<p>휴! 정문에는 선생님이 안 계셨네요. 무사 통과!</p>";
                }
            } else { 
                if (!teacherAtMainGate) { 
                    caught = true;
                    endingText = "[지각해서 후문으로 들어갔지만, 결국 선생님의 눈을 피하지 못하고 잔소리를 듣게 되었다.]";
                    feedbackHtml += "<p>이런! 후문으로 들어갔다가 단속에 걸렸습니다!</p>";
                } else {
                    endingText = "[지각했지만 후문으로 향했고, 다행히 선생님이 안 계셔서 조용히 교실로 들어갈 수 있었다!]";
                    feedbackHtml += "<p>휴! 후문에는 선생님이 안 계셨네요. 무사 통과!</p>";
                }
            }
            playerStats.latePenalty = caught;
        }
        else if (screenNum === 4) { 
            let correctAnswer = Math.floor(Math.random() * 4) + 1; 
            let playerPick = 0;
            if (choice === 'A') playerPick = 1;
            else if (choice === 'B') playerPick = 2;
            else if (choice === 'C') playerPick = 3;
            else if (choice === 'D') playerPick = 4;

            playerStats.quizCorrect = (playerPick === correctAnswer);
            feedbackHtml = `<h4>결과: 당신의 선택은 ${playerPick}번!</h4><p>(각 선택지가 정답일 확률은 1/4 = 25%입니다.)</p>`;
            if (playerStats.quizCorrect) {
                feedbackHtml += `<p>🎉 정답입니다! 🎉 운이 좋았네요!</p>`;
                endingText = `[시험 중 모르는 문제는 ${playerPick}번으로 찍었는데, 행운의 여신이 함께했는지 정답이었다!]`;
            } else {
                feedbackHtml += `<p>아쉽지만 오답입니다. (정답은 ${correctAnswer}번이었습니다.)</p>`;
                endingText = `[시험 중 모르는 문제는 ${playerPick}번으로 찍었지만, 아쉽게도 정답을 피해갔다. (정답:${correctAnswer}번)]`;
            }
        }
        else if (screenNum === 5) { 
             if (choice === 'A') {
                let person1Buys = Math.random() < 0.5; 
                let person2Buys = Math.random() < 0.5; 
                let breadAvailableForPlayer = true;

                feedbackHtml = "<h4>결과: 빵의 행방은?</h4>"
                if (person1Buys) {
                    breadAvailableForPlayer = false;
                    feedbackHtml += "<p>첫 번째 사람이 초코 크림빵을 사갔습니다! (선택 확률 50%)</p>";
                } else {
                    feedbackHtml += "<p>첫 번째 사람은 다른 빵을 골랐습니다. (다른 빵 선택 확률 50%)</p>";
                    if (person2Buys) {
                        breadAvailableForPlayer = false;
                        feedbackHtml += "<p>이어서 두 번째 사람이 초코 크림빵을 사갔습니다! (선택 확률 50%)</p>";
                    } else {
                        feedbackHtml += "<p>두 번째 사람도 다른 빵을 골랐습니다! (다른 빵 선택 확률 50%)</p>";
                    }
                }

                if (breadAvailableForPlayer) {
                    feedbackHtml += "<p><strong>기회!</strong> 앞의 두 사람이 모두 다른 빵을 고를 확률(0.5 × 0.5 = 0.25, 즉 25%)이 현실이 되어, 드디어 당신 차례입니다!</p>";
                    if (money >= chocoBreadPrice) {
                        money -= chocoBreadPrice;
                        playerStats.gotChocoBread = true;
                        feedbackHtml += "<p>🎉 초코 크림빵을 구매했습니다! 맛있게 드세요!</p>";
                        endingText = "[초코 크림빵 줄에서 끈기 있게 기다린 결과, 마지막 남은 빵을 차지할 수 있었다! 정말 꿀맛이었다.]";
                    } else {
                        feedbackHtml += "<p>이런... 빵은 남았지만 돈이 부족해서 살 수가 없네요.</p>";
                        endingText = "[내 차례까지 초코 크림빵이 남아 있었지만, 이런! 돈이 부족해서 결국 사지 못했다. 다른 곳에 쓰지 말 걸...]";
                    }
                } else {
                    feedbackHtml += "<p>아쉽게도 앞사람 중 누군가가 마지막 초코 크림빵을 사 버렸습니다. (누군가 살 확률 75%)</p>";
                    endingText = "[기대하며 초코 크림빵 줄을 기다렸지만, 아쉽게도 바로 앞에서 마지막 빵이 팔려버렸다.]";
                }
            } else { 
                feedbackHtml = "<h4>결과: 다른 빵집으로...</h4><p>마지막 빵을 기다리는 대신 다른 빵집으로 향했습니다. 그곳엔 빵이 있었을까요?</p>";
                endingText = "[초코 크림빵을 포기하고 다른 빵집까지 가봤지만, 결국 거기에도 없어 오늘은 초코 크림빵을 맛보지 못했다.]";
            }
        }
        else if (screenNum === 6) { // 도서관
            let sumiComes = Math.random() < 0.5; 
            let jieunComes = Math.random() < (1/3); 

            if (choice === 'A') { // 도서관에 간 경우
                feedbackHtml = "<h4>결과: 도서관에는...</h4>";
                feedbackHtml += `<p>수미가 올 확률(50%)은 ${sumiComes ? "현실로!" : "빗나갔고,"} 지은이가 올 확률(약 33%)은 ${jieunComes ? "현실이 되었네요!" : "빗나갔습니다."}</p>`;

                if (sumiComes && jieunComes) {
                    feedbackHtml += "<p>🎉 두 친구를 모두 만났습니다! (수미와 지은이 둘 다 만날 확률: 0.5 × 0.33 ≈ 16.5%)</p>";
                    endingText = "[도서관에 갔더니, 기대했던 대로 수미와 지은이를 둘 다 만나 즐거운 시간을 보냈다!]";
                } else if (sumiComes) {
                    feedbackHtml += "<p>수미만 만났습니다. (수미만 올 확률: 0.5 × (1-1/3) ≈ 33.3%)</p>";
                    endingText = "[도서관에서 수미는 만났지만, 지은이는 오지 않아 조금 아쉬웠다.]";
                } else if (jieunComes) {
                    feedbackHtml += "<p>지은이만 만났습니다. ((1-0.5) × 1/3 ≈ 16.7%)</p>";
                    endingText = "[도서관에서 지은이는 만났지만, 수미는 오지 않아 조금 아쉬웠다.]";
                } else {
                    feedbackHtml += "<p>아무도 만나지 못했습니다. (둘 다 안 올 확률: (1-0.5) × (1-1/3) ≈ 33.3%)</p>";
                    endingText = "[도서관에 갔지만, 기대와 달리 수미도 지은이도 없어 홀로 책만 읽다 돌아왔다.]";
                }
            } else { // B 선택 (도서관에 안 간 경우)
                feedbackHtml = "<h4>결과: 집에서 휴식</h4><p>당신은 오늘 도서관에 가지 않고 집에서 다른 활동을 하기로 결정했습니다.</p>";
                feedbackHtml += "<p class='player-thought'>그 시각, 도서관에서는...</p>"; 

                if (sumiComes && jieunComes) {
                    feedbackHtml += "<p>수미와 지은이 둘 다 도서관에 왔었네요! (둘 다 올 확률: 약 16.5%) 당신이 갔더라면 함께 즐거웠을지도 모릅니다.</p>";
                } else if (sumiComes) {
                    feedbackHtml += "<p>수미는 도서관에 왔었지만, 지은이는 오지 않았어요. (수미만 올 확률: 약 33.3%) 당신이 갔더라면 수미와 이야기를 나눴을지도...</p>";
                } else if (jieunComes) {
                    feedbackHtml += "<p>지은이는 도서관에 왔었지만, 수미는 오지 않았어요. (지은이만 올 확률: 약 16.7%) 당신이 갔더라면 지은이와 시간을 보냈을지도...</p>";
                } else {
                    feedbackHtml += "<p>수미도 지은이도 도서관에 오지 않았네요. (둘 다 안 올 확률: 약 33.3%) 어쩌면 오늘은 집에서 쉬는 게 좋은 선택이었을 수도 있겠네요.</p>";
                }
                endingText = "[오늘은 도서관에 가는 대신 다른 활동을 하기로 결정했다. 그 시간, 친구들은 도서관에서 각자의 시간을 보냈을지도 모른다.]";
            }
        }


        if (endingText) endingTexts.push(endingText);
        // 화면 2가 아닌 경우에만 disableChoiceButtons와 displayImmediateFeedback 직접 호출
        if (screenNum !== 2) {
            displayImmediateFeedback(screenNum, feedbackHtml, showMainNextBtn);
        }
    }

    function proceedToNext(prevScreenNum) {
        const feedbackDiv = document.getElementById('feedback' + prevScreenNum);
        const nextButton = document.getElementById('nextBtn' + prevScreenNum);
        if(feedbackDiv) feedbackDiv.innerHTML = "";
        if(nextButton) nextButton.style.display = 'none';
        
        // 화면 2의 경우, 초기 선택지 버튼들(choices2_initial)을 다시 보이도록 처리하고, 버튼들도 활성화
        if (prevScreenNum === 2) {
            const initialChoices2 = document.getElementById('choices2_initial');
            if (initialChoices2) {
                initialChoices2.style.display = 'block'; // 다시 보이게
                initialChoices2.querySelectorAll('button').forEach(button => {
                    button.disabled = false; // 버튼 활성화
                });
            }
        } else {
             // 다른 화면들의 버튼들도 재시작을 위해 활성화 (restartGame에서 전체적으로 하지만, 여기서도 해두면 좋음)
            disableChoiceButtons('screen' + prevScreenNum, false);
        }


        currentScreenNum++;
        if (currentScreenNum > 6) {
            displayEnding();
        } else {
            showScreen(currentScreenNum);
            updateMoneyDisplay();
            // 다음 화면의 버튼들도 활성화 (게임 시작 시 initializeGame에서 하지만, 혹시 모르니)
            disableChoiceButtons(currentScreenNum, false);
            if (currentScreenNum === 2) { // 다음 화면이 2번 화면일 경우, 초기 상태로
                 const initialChoices2 = document.getElementById('choices2_initial');
                 if (initialChoices2) initialChoices2.style.display = 'block';
                 disableChoiceButtons('screen2', false);
            }
        }
    }

    function displayEnding() {
        showScreen('Ending');
        const endingOutput = document.getElementById('endingTextOutput');
        let fullEndingText = "<p><strong>나의 선택들이 모여 이런 하루가 되었어요...</strong></p>";
        endingTexts.forEach(text => {
            fullEndingText += `<p>${text}</p>`;
        });

        if (playerStats.lotteryAttempts > 0) {
            if (playerStats.lotteryPrize) {
                fullEndingText += `<p>[뽑기 요약: 총 ${playerStats.lotterySpent}원을 사용하여 ${playerStats.lotteryAttempts}번의 도전 끝에 <span class="highlight">10%</span>의 확률을 뚫고 상품을 얻었다!]</p>`;
            } else {
                fullEndingText += `<p>[뽑기 요약: 총 ${playerStats.lotterySpent}원을 사용하고 ${playerStats.lotteryAttempts}번 도전했지만, 아쉽게도 <span class="highlight">10%</span>의 확률 앞에서 상품을 얻지 못했다.]</p>`;
            }
        } else if (currentScreenNum > 2) { // 뽑기 화면을 거쳤는데 시도 0번이면 포기한 것
             // 이미 handleLotteryChoice('initial_pass')에서 endingTexts에 추가됨. 필요시 중복 제거
        }


        fullEndingText += "<hr><p><strong>[하루 요약 및 상태]</strong></p>";
        fullEndingText += `<p>최종 소지금: ${money}원</p>`;
        if(playerStats.hasUmbrella) fullEndingText += "<p>- 챙겨간 우산이 있었다.</p>";
        if(playerStats.gotChocoBread) fullEndingText += "<p>- 맛있는 초코 크림빵을 먹었다!</p>";
        if(playerStats.latePenalty) fullEndingText += "<p>- 지각으로 선생님께 꾸중을 들었다.</p>";
        
        // 시험 결과는 currentScreenNum이 4를 넘어야 유효함 (시험을 봤다는 뜻)
        if (document.getElementById('screen4').classList.contains('active') === false && currentScreenNum > 4) { // 화면4를 지나왔다면
            if(playerStats.quizCorrect) fullEndingText += "<p>- 시험에서 찍은 문제가 정답이었다!</p>";
            else fullEndingText += "<p>- 시험에서 찍은 문제는 틀렸다.</p>";
        }


        endingOutput.innerHTML = fullEndingText;
    }

    function restartGame() {
        currentScreenNum = 1;
        money = 1000;
        endingTexts = [];
        playerStats = {
            hasUmbrella: false,
            lotteryPrize: false,
            lotteryAttempts: 0,
            lotterySpent: 0,
            gotChocoBread: false,
            latePenalty: false,
            quizCorrect: false
        };
        initializeGame(); 
    }

    window.onload = initializeGame;
</script>

</body>
</html>