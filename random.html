<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>확률 의사결정 게임</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .game-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .game-screen {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .game-screen.active {
            display: block;
        }
        .screen-title {
            font-size: 1.5em;
            color: #007bff;
            margin-bottom: 5px;
        }
        .location {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }
        .situation, .dilemma {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .choices button, .feedback-actions button {
            display: inline-block; 
            width: auto; 
            padding: 10px 15px; 
            margin: 5px; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .choices button.full-width { 
            display: block;
            width: 100%;
        }
        .choices button:hover, .feedback-actions button:hover {
            background-color: #0056b3;
        }
        .choices button:disabled, .feedback-actions button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .player-thought {
            font-style: italic;
            color: #555;
            margin-top: 10px;
            padding: 8px;
            background-color: #e9e9e9;
            border-radius: 3px;
        }
        .immediate-feedback {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }
        .immediate-feedback h4 {
            margin-top: 0;
            color: #0056b3;
        }
        .next-button { 
            display: none; 
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .next-button:hover {
            background-color: #218838;
        }
        #endingScreen .ending-text {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4caf50;
        }
        .highlight {
            font-weight: bold;
            color: #d9534f; 
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-effect {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes good-flash {
            0%, 100% { background-color: #f9f9f9; border-left-color: #007bff; }
            50% { background-color: #d4edda; border-left-color: #28a745; } 
        }
        .good-outcome-flash { 
            animation: good-flash 0.8s ease-out;
        }

    </style>
</head>
<body>

<div class="game-container">
    <h1>나의 선택은?</h1>

    <div id="screen1" class="game-screen active">
        <h2 class="screen-title">선택 1: 아침, 우산과의 눈치 싸움</h2>
        <p class="location">📍 장소: 아침, 현관 앞</p>
        <p class="situation">
            TV에서 아나운서의 목소리가 흘러나온다.<br>
            "오늘 전국적으로 비 소식이 있습니다. 현재 예상 강수 확률은 <span id="rainChance" class="highlight">[xx]</span>%입니다."<br>
            창밖을 보니 하늘은 아직 흐리기만 하다.
        </p>
        <p class="dilemma">🤔 당신의 고민: 우산을 가져갈까, 말까?</p>
        <div class="choices">
            <button class="full-width" id="s1c1" onclick="handleChoice('screen1', 'A')">A) 혹시 모르니, 챙겨 나간다.</button>
            <button class="full-width" id="s1c2" onclick="handleChoice('screen1', 'B')">B) 이 정도 확률이면 괜찮아, 그냥 나간다.</button>
        </div>
        <div class="immediate-feedback" id="feedback1"></div>
        <button class="next-button" id="nextBtn1" onclick="proceedToNext(1)">다음으로</button>
    </div>

    <div id="screen2" class="game-screen">
        <h2 class="screen-title">선택 2: 길가의 유혹, 10%의 도전</h2>
        <p class="location">📍 장소: 등굣길, 문구점 앞</p>
        <p class="situation">
            등굣길, 문구점 앞에 놓인 상품 뽑기 기계가 시선을 사로잡는다.<br>
            "✨인기 캐릭터 한정판 인형 획득 찬스!✨ 단돈 100원! 성공 확률 <span class="highlight">10%</span>!"<br>
            (현재 내 지갑에는 <span id="currentMoneyLottery" class="highlight">[현재 소지금]</span>원이 있다.)
        </p>
        <p class="dilemma">🤔 당신의 고민: 10%의 확률... 한번 도전해 볼까?</p>
        <div class="player-thought">"10%면... 열 번 중 한 번은 되지 않을까?" (내적 고민)</div>
        <div class="choices" id="choices2_initial">
            <button class="full-width" id="s2c1_initial" onclick="handleLotteryChoice('initial_try')">A) 좋아, 10%의 행운에 도전한다! (100원 차감)</button>
            <button class="full-width" id="s2c2_initial" onclick="handleLotteryChoice('initial_pass')">B) 으음... 그래도 실패할 것 같아. 그냥 지나가자.</button>
        </div>
        <div class="immediate-feedback" id="feedback2">
        </div>
        <button class="next-button" id="nextBtn2" onclick="proceedToNext(2)" style="display:none;">다음 화면으로</button>
    </div>

    <div id="screen3" class="game-screen">
        <h2 class="screen-title">선택 3: 지각 위기! 정문 vs 후문</h2>
        <p class="location">📍 장소: 아슬아슬 등굣길, 학교 앞</p>
        <p class="situation">
            이런, 아침부터 문구점 앞 뽑기 기계에 한눈을 팔다가 그만 등교 시간에 늦어버렸다!<br> 
            허겁지겁 학교 앞에 도착하니 이미 수업 시작 종이 울린 것 같다.<br>
            정문으로 당당히 들어갈까, 아니면 후문으로 몰래 들어갈까?<br>
            오늘은 유난히 선생님들이 지각생을 잡을 것 같은 불길한 예감이 스친다.<br>
            (교장 선생님의 특별 지시로, 오늘 정문과 후문 중 <span class="highlight">한 곳에서만</span> 선생님이 지각 단속을 하신다!)
        </p>
        <p class="dilemma">🤔 당신의 고민: 어느 문으로 들어가야 무사할까? 나의 선택은?</p>
        <div class="choices">
            <button class="full-width" id="s3c1" onclick="handleChoice('screen3', 'A')">A) 정면 돌파! 정문으로 가자!</button>
            <button class="full-width" id="s3c2" onclick="handleChoice('screen3', 'B')">B) 은밀하게... 후문으로 가자.</button>
        </div>
        <div class="immediate-feedback" id="feedback3"></div>
        <button class="next-button" id="nextBtn3" onclick="proceedToNext(3)">다음으로</button>
    </div>

    <div id="screen4" class="game-screen">
        <h2 class="screen-title">선택 4: 시험 시간, 마지막 한 문제</h2>
        <p class="location">📍 장소: 시험 시간 - 교실</p>
        <p class="situation">
            시험 종료 5분 전. 마지막 문제를 붙잡고 있지만... 아, 도저히 모르겠다!<br>
            하지만 포기할 순 없지. 답은 4개의 선택지 중 하나!
        </p>
        <p class="dilemma">🤔 당신의 고민: 어떤 번호로 찍어야 할까? 나의 직감을 믿어보자!</p>
        <div class="choices">
            <button class="full-width" id="s4c1" onclick="handleChoice('screen4', 'A')">A) 왠지 느낌이 오는 1번!</button>
            <button class="full-width" id="s4c2" onclick="handleChoice('screen4', 'B')">B) 가장 안 나올 것 같은 2번!</button>
            <button class="full-width" id="s4c3" onclick="handleChoice('screen4', 'C')">C) 나의 행운의 숫자 3번!</button>
            <button class="full-width" id="s4c4" onclick="handleChoice('screen4', 'D')">D) 모르겠을 땐 마지막 번호 4번!</button>
        </div>
        <div class="immediate-feedback" id="feedback4"></div>
        <button class="next-button" id="nextBtn4" onclick="proceedToNext(4)">다음으로</button>
    </div>

    <div id="screen5" class="game-screen">
        <h2 class="screen-title">선택 5: 빵집의 운명, 마지막 초코 크림빵</h2>
        <p class="location">📍 장소: 하굣길, 동네 빵집</p> 
        <p class="situation">
            하굣길, 내가 제일 좋아하는 초코 크림빵을 사러 빵집에 왔다.<br> 
            그런데... 내 앞에 이미 두 명이 줄을 서 있고, 진열대에는 초코 크림빵이 <span class="highlight">딱 한 개</span> 남아있다!<br>
            앞 사람들은 빵을 하나씩만 살 예정이고, 각자 이 초코 크림빵을 고를 확률은 <span class="highlight">50%</span>라고 한다.
        </p>
        <p class="dilemma">🤔 당신의 고민: 이 줄, 계속 서야 할까? 아니면 그냥 집에 갈까?</p>
        <div class="choices">
            <button class="full-width" id="s5c1" onclick="handleChoice('screen5', 'A')">A) 마지막 희망을 걸고 기다려본다!</button>
            <button class="full-width" id="s5c2" onclick="handleChoice('screen5', 'B')">B) 초코 크림빵 안 사고 그냥 집에 간다.</button> 
        </div>
        <div class="immediate-feedback" id="feedback5"></div>
        <button class="next-button" id="nextBtn5" onclick="proceedToNext(5)">다음으로</button>
    </div>

    <div id="screen6" class="game-screen">
        <h2 class="screen-title">선택 6: 도서관 잠입 작전</h2>
        <p class="location">📍 장소: 하굣길</p> 
        <p class="situation">
            하굣길, 조용히 책을 읽고 싶은데 혹시 도서관에서 친구들을 마주칠까 걱정이다.<br> 
            수미가 오늘 도서관에 올 확률은 <span class="highlight">50%</span>, 지은이가 올 확률은 약 <span class="highlight">33%</span>(1/3)이라고 한다.<br>
            둘 다 마주치지 않고 몰래 도서관을 이용하고 싶다!
        </p>
        <p class="dilemma">🤔 당신의 고민: 도서관에 몰래 가 볼까?</p>
        <div class="choices">
            <button class="full-width" id="s6c1" onclick="handleChoice('screen6', 'A')">A) 그래, 조용히 도서관에 가보자!</button>
            <button class="full-width" id="s6c2" onclick="handleChoice('screen6', 'B')">B) 아니야, 그냥 안전하게 집으로 가자.</button>
        </div>
        <div class="immediate-feedback" id="feedback6"></div>
        <button class="next-button" id="nextBtn6" onclick="proceedToNext(6)">다음으로</button>
    </div>

    <div id="endingScreen" class="game-screen">
        <h2 class="screen-title">나의 하루 돌아보기</h2>
        <div id="endingTextOutput" class="ending-text">
            <p>나의 선택들이 모여 이런 하루가 되었어요...</p>
        </div>
        <div class="choices">
            <button class="full-width" onclick="restartGame()">다시 시작하기</button>
        </div>
    </div>
</div>

<script>
    let currentScreenNum = 1;
    let money = 1000;
    const chocoBreadPrice = 1000;
    let rainChancePercentage = 0;
    let endingTexts = [];
    let playerStats = {
        hasUmbrella: false,
        lotteryPrize: false,
        lotteryAttempts: 0,
        lotterySpent: 0,
        gotChocoBread: false,
        latePenalty: false,
        quizCorrect: false,
        librarySecretSuccess: null 
    };

    const gameContainerElement = document.querySelector('.game-container');

    function triggerEffect(type) {
        const activeScreen = document.getElementById('screen' + currentScreenNum); 
        if (!activeScreen && currentScreenNum !== 'Ending') return; 

        const feedbackDiv = activeScreen ? activeScreen.querySelector('.immediate-feedback') : null;

        if (type === 'bad') {
            gameContainerElement.classList.add('shake-effect');
            setTimeout(() => {
                gameContainerElement.classList.remove('shake-effect');
            }, 500); 
        } else if (type === 'good' && feedbackDiv) {
            feedbackDiv.classList.add('good-outcome-flash');
            setTimeout(() => {
                feedbackDiv.classList.remove('good-outcome-flash');
            }, 800); 
        }
    }


    function initializeGame() {
        rainChancePercentage = Math.floor(Math.random() * 81) + 10;
        document.getElementById('rainChance').textContent = rainChancePercentage;
        updateMoneyDisplay();
        for (let i = 1; i <= 6; i++) {
            disableChoiceButtons('screen' + i, false); 
            const feedbackDiv = document.getElementById('feedback' + i);
            const nextButton = document.getElementById('nextBtn' + i);
            if(feedbackDiv) feedbackDiv.innerHTML = "";
            if(nextButton) nextButton.style.display = 'none';
        }
        const choices2Initial = document.getElementById('choices2_initial');
        if(choices2Initial) choices2Initial.style.display = 'block';
        showScreen(currentScreenNum);
    }

    function showScreen(screenNumber) {
        document.querySelectorAll('.game-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        const targetScreen = document.getElementById(screenNumber === 'Ending' ? 'endingScreen' : 'screen' + screenNumber);
        if(targetScreen) {
            targetScreen.classList.add('active');
        }
    }

    function updateMoneyDisplay() {
        const moneyDisplayLottery = document.getElementById('currentMoneyLottery');
        if (moneyDisplayLottery) moneyDisplayLottery.textContent = money;
    }

    function disableChoiceButtons(screenIdOrNum, disable = true) {
        const screenId = (typeof screenIdOrNum === 'string') ? screenIdOrNum : 'screen' + screenIdOrNum;
        const screen = document.getElementById(screenId);
        if (screen) {
            const choiceDiv = screen.querySelector('.choices'); 
            if(choiceDiv) {
                choiceDiv.querySelectorAll('button').forEach(button => {
                    button.disabled = disable;
                });
            }
            if (screenId === 'screen2') {
                const initialChoices2 = document.getElementById('choices2_initial');
                if (initialChoices2) {
                    initialChoices2.querySelectorAll('button').forEach(button => {
                        button.disabled = disable;
                    });
                }
            }
        }
    }

    function showNextButton(screenNum, show = true) {
         const nextButton = document.getElementById('nextBtn' + screenNum);
         if(nextButton) {
            nextButton.style.display = show ? 'block' : 'none';
         }
    }

    function displayImmediateFeedback(screenNum, feedbackHtml, showMainNextBtn = false) {
        const feedbackDiv = document.getElementById('feedback' + screenNum);
        if(feedbackDiv){
            feedbackDiv.innerHTML = feedbackHtml;
        }
        if (screenNum !== 2) { 
            disableChoiceButtons(screenNum, true);
        }
        if(showMainNextBtn) {
             showNextButton(screenNum, true);
        }
    }

    function handleLotteryChoice(action) {
        const feedbackDiv = document.getElementById('feedback2');
        const initialChoicesDiv = document.getElementById('choices2_initial');
        const mainNextButton = document.getElementById('nextBtn2');
        let feedbackHtml = "";

        if(initialChoicesDiv) initialChoicesDiv.style.display = 'none';
        mainNextButton.style.display = 'none';

        if (action === 'initial_pass') {
            feedbackHtml = "<h4>결과: 도전 포기</h4><p>성공 확률 10%는 여전히 낮다고 판단하여, 신중하게 돈을 아끼기로 결정했습니다.</p>";
            endingTexts.push("[10%의 뽑기 확률 앞에서 도전을 포기하고 돈을 아꼈다.]");
            feedbackDiv.innerHTML = feedbackHtml;
            showNextButton(2, true); 
        } else if (action === 'initial_try' || action === 'retry') {
            if (money >= 100) {
                money -= 100;
                playerStats.lotteryAttempts++;
                playerStats.lotterySpent += 100;
                updateMoneyDisplay();
                let success = Math.random() < 0.10; 

                if (success) {
                    playerStats.lotteryPrize = true;
                    feedbackHtml = `<h4>결과: 🎉 대성공! (${playerStats.lotteryAttempts}번째 시도) 🎉</h4><p>상품 뽑기 성공 확률 <span class="highlight">10%</span>에 도전하여, 드디어 상품을 뽑았습니다! 총 ${playerStats.lotterySpent}원을 사용했습니다.</p>`;
                    triggerEffect('good');
                    feedbackDiv.innerHTML = feedbackHtml;
                    showNextButton(2, true); 
                } else {
                    feedbackHtml = `<h4>결과: 꽝! (시도 횟수: ${playerStats.lotteryAttempts}, 남은 돈: ${money}원)</h4><p>상품 뽑기 성공 확률 <span class="highlight">10%</span>에 도전했지만, 아쉽게도 90%의 실패 확률이 더 높았네요. 100원을 잃었습니다.</p>`;
                    triggerEffect('bad');
                    if (money >= 100) {
                        feedbackHtml += `<div class="feedback-actions"><button onclick="handleLotteryChoice('retry')">다시 도전한다! (100원 사용)</button> <button onclick="quitLotteryAndProceed()">그만하고 다음으로 넘어간다.</button></div>`;
                    } else {
                        feedbackHtml += "<p>돈이 부족하여 더 이상 도전할 수 없습니다.</p>";
                        feedbackHtml += `<div class="feedback-actions"><button onclick="quitLotteryAndProceed()">다음으로 넘어간다.</button></div>`;
                    }
                    feedbackDiv.innerHTML = feedbackHtml;
                }
            } else {
                feedbackHtml = "<h4>결과: 시도 실패!</h4><p>뽑기에 도전하고 싶었지만, 아쉽게도 돈이 부족해서 시도조차 못했습니다.</p>";
                triggerEffect('bad');
                feedbackDiv.innerHTML = feedbackHtml;
                showNextButton(2, true); 
            }
        }
    }

    function quitLotteryAndProceed() {
        proceedToNext(2);
    }

    function handleChoice(screenId, choice) {
        const screenNum = parseInt(screenId.replace('screen', ''));
        // 화면 2는 handleLotteryChoice에서 직접 처리하므로, 여기서는 일반 버튼 클릭 시에는 아무것도 하지 않도록 수정.
        // (초기 버튼에서 handleLotteryChoice를 직접 호출하도록 변경했기 때문)
        if (screenNum === 2 && (document.getElementById('s2c1_initial') && document.getElementById('s2c2_initial'))) {
             // 이 조건은 초기 버튼들이 handleLotteryChoice를 직접 호출하므로,
             // 일반 handleChoice가 중복 실행되지 않도록 방지하는 목적.
             // 하지만, 더 명확하게는 screen2의 초기 버튼은 onclick="handleLotteryChoice(...)"를 사용하고
             // handleChoice에서는 screenNum === 2 케이스를 완전히 제외하거나,
             // 재도전 등의 버튼이 handleChoice를 호출하지 않도록 구분해야 합니다.
             // 현재 구조상 handleLotteryChoice가 초기 버튼에서 호출되므로, 이 함수에서 screenNum === 2를 스킵해도 무방.
            return; 
        }


        let feedbackHtml = "";
        let endingText = "";
        let showMainNextBtn = true;
        let effectType = null; 

        if (screenNum === 1) {
            let actuallyRained = Math.random() * 100 < rainChancePercentage;
            feedbackHtml += `<h4>결과: ${actuallyRained ? "비가 실제로 내렸습니다!" : "오늘은 비가 오지 않았습니다!"}</h4>`;
            feedbackHtml += `<p>오늘 비 올 확률은 ${rainChancePercentage}%였습니다. ${actuallyRained ? "그 결과, 실제로도 비가 내렸습니다." : "그 결과, 실제로는 비가 내리지 않았습니다."}</p>`;
            
            if (choice === 'A') { 
                playerStats.hasUmbrella = true;
                if (actuallyRained) {
                    endingText = "[비 오는 날, 우산을 챙겨간 덕분에 보송보송하게 하루를 보냈다.]";
                    feedbackHtml += `<p>당신은 우산을 챙겼습니다. 현명한 선택이었네요!</p>`;
                    effectType = 'good';
                } else {
                    endingText = "[맑은 날, 혹시나 해서 챙겼던 우산이 조금 무거웠지만 그래도 안심이었다.]";
                    feedbackHtml += `<p>당신은 우산을 챙겼습니다. 조금 번거로웠을 수도 있지만, 대비는 좋은 거죠!</p>`;
                }
            } else { 
                playerStats.hasUmbrella = false;
                if (actuallyRained) {
                    endingText = "[비 오는 날, 우산을 안 가져가서 결국 예상치 못한 비에 쫄딱 젖고 말았다.]";
                    feedbackHtml += `<p>당신은 우산을 챙기지 않았습니다. 이런! 비를 맞게 되었네요.</p>`;
                    effectType = 'bad';
                } else {
                    endingText = "[맑은 날, 우산을 안 가져간 나의 가벼운 발걸음은 탁월한 선택이었다!]";
                    feedbackHtml += `<p>당신은 우산을 챙기지 않았습니다. 예측 성공! 가뿐한 하루!</p>`;
                    effectType = 'good';
                }
            }
        }
        else if (screenNum === 3) { 
            let teacherAtMainGate = Math.random() < 0.5; 
            let caught = false;
            feedbackHtml += `<h4>결과: 선생님은... ${teacherAtMainGate ? "정문" : "후문"}에 계셨습니다!</h4><p>(각 문에 선생님이 계실 확률은 50%였습니다.)</p>`;

            if (choice === 'A') { 
                if (teacherAtMainGate) {
                    caught = true;
                    endingText = "[뽑기 구경하다 늦어 정문으로 갔지만, 결국 선생님께 붙잡혀 따끔한 훈계를 들어야 했다.]";
                    feedbackHtml += "<p>이런! 정문으로 들어갔다가 단속에 걸렸습니다!</p>";
                    effectType = 'bad';
                } else {
                    endingText = "[뽑기 구경하다 늦었지만 정문으로 향했고, 다행히 선생님이 안 계셔서 무사히 교실로 들어갔다!]";
                    feedbackHtml += "<p>휴! 정문에는 선생님이 안 계셨네요. 무사 통과!</p>";
                    effectType = 'good';
                }
            } else { 
                if (!teacherAtMainGate) { 
                    caught = true;
                    endingText = "[뽑기 구경하다 늦어 후문으로 갔지만, 결국 선생님의 눈을 피하지 못하고 잔소리를 듣게 되었다.]";
                    feedbackHtml += "<p>이런! 후문으로 들어갔다가 단속에 걸렸습니다!</p>";
                    effectType = 'bad';
                } else {
                    endingText = "[뽑기 구경하다 늦었지만 후문으로 향했고, 다행히 선생님이 안 계셔서 조용히 교실로 들어갈 수 있었다!]";
                    feedbackHtml += "<p>휴! 후문에는 선생님이 안 계셨네요. 무사 통과!</p>";
                    effectType = 'good';
                }
            }
            playerStats.latePenalty = caught;
        }
        else if (screenNum === 4) { 
            let correctAnswer = Math.floor(Math.random() * 4) + 1; 
            let playerPick = 0;
            if (choice === 'A') playerPick = 1;
            else if (choice === 'B') playerPick = 2;
            else if (choice === 'C') playerPick = 3;
            else if (choice === 'D') playerPick = 4;

            playerStats.quizCorrect = (playerPick === correctAnswer);
            feedbackHtml = `<h4>결과: 당신의 선택은 ${playerPick}번!</h4><p>(각 선택지가 정답일 확률은 1/4 = 25%입니다.)</p>`;
            if (playerStats.quizCorrect) {
                feedbackHtml += `<p>🎉 정답입니다! 🎉 운이 좋았네요!</p>`;
                endingText = `[시험 중 모르는 문제는 ${playerPick}번으로 찍었는데, 행운의 여신이 함께했는지 정답이었다!]`;
                effectType = 'good';
            } else {
                feedbackHtml += `<p>아쉽지만 오답입니다. (정답은 ${correctAnswer}번이었습니다.)</p>`;
                endingText = `[시험 중 모르는 문제는 ${playerPick}번으로 찍었지만, 아쉽게도 정답을 피해갔다. (정답:${correctAnswer}번)]`;
                effectType = 'bad';
            }
        }
        else if (screenNum === 5) { 
             if (choice === 'A') { 
                let person1Buys = Math.random() < 0.5; 
                let person2Buys = Math.random() < 0.5; 
                let breadAvailableForPlayer = true;

                feedbackHtml = "<h4>결과: 빵의 행방은?</h4>"
                if (person1Buys) {
                    breadAvailableForPlayer = false;
                    feedbackHtml += "<p>첫 번째 사람이 초코 크림빵을 사갔습니다! (선택 확률 50%)</p>";
                } else {
                    feedbackHtml += "<p>첫 번째 사람은 다른 빵을 골랐습니다. (다른 빵 선택 확률 50%)</p>";
                    if (person2Buys) {
                        breadAvailableForPlayer = false;
                        feedbackHtml += "<p>이어서 두 번째 사람이 초코 크림빵을 사갔습니다! (선택 확률 50%)</p>";
                    } else {
                        feedbackHtml += "<p>두 번째 사람도 다른 빵을 골랐습니다! (다른 빵 선택 확률 50%)</p>";
                    }
                }

                if (breadAvailableForPlayer) {
                    feedbackHtml += "<p><strong>기회!</strong> 앞의 두 사람이 모두 다른 빵을 고를 확률(0.5 × 0.5 = 0.25, 즉 25%)이 현실이 되어, 드디어 당신 차례입니다!</p>";
                    feedbackHtml += "<p class='player-thought'>참고: 내가 초코 크림빵을 살 수 있는 경우는 첫 번째 사람이 다른 빵을 사고(1/2 확률), 두 번째 사람도 다른 빵을 사는 경우(1/2 확률)이므로 그 확률은 1/2 × 1/2 = 1/4 (25%)입니다.</p>"; 

                    if (money >= chocoBreadPrice) {
                        money -= chocoBreadPrice;
                        playerStats.gotChocoBread = true;
                        feedbackHtml += "<p>🎉 초코 크림빵을 구매했습니다! 맛있게 드세요!</p>";
                        endingText = "[하굣길, 빵집 줄에서 기다린 끝에 마지막 초코 크림빵을 차지할 수 있었다! 정말 꿀맛이었다.]";
                        effectType = 'good';
                    } else {
                        feedbackHtml += "<p>이런... 빵은 남았지만 돈이 부족해서 살 수가 없네요.</p>";
                        endingText = "[하굣길, 빵집에서 내 차례까지 빵이 남아 있었지만, 돈이 부족해서 결국 사지 못했다. 다른 곳에 쓰지 말 걸...]";
                        effectType = 'bad';
                    }
                } else {
                    feedbackHtml += "<p>아쉽게도 앞사람 중 누군가가 마지막 초코 크림빵을 사 버렸습니다. (누군가 살 확률 75%)</p>";
                    feedbackHtml += "<p class='player-thought'>참고: 내가 빵을 살 수 없을 경우는 앞사람 중 적어도 한 명이 빵을 사는 경우입니다. 이는 전체 확률 1에서 두 사람 모두 빵을 사지 않을 확률(1/4)을 뺀 3/4 (75%)에 해당합니다.</p>";
                    endingText = "[하굣길, 빵집에서 기대하며 줄을 기다렸지만, 아쉽게도 바로 앞에서 마지막 빵이 팔려버렸다.]";
                    effectType = 'bad';
                }
            } else { 
                feedbackHtml = "<h4>결과: 집으로...</h4><p>당신은 하굣길에 초코 크림빵을 사지 않고 그냥 집으로 가기로 했습니다.</p>";
                feedbackHtml += "<p class='player-thought'>그렇다면, 빵집의 마지막 초코 크림빵은 어떻게 되었을까요?</p>";
                let person1Buys = Math.random() < 0.5;
                let person2Buys = Math.random() < 0.5;
                let breadWouldHaveBeenAvailable = true; 
                if (person1Buys) {
                    breadWouldHaveBeenAvailable = false;
                    feedbackHtml += "<p>아마도... 첫 번째 사람이 그 초코 크림빵을 사갔을 겁니다! (선택 확률 50%)</p>";
                } else {
                    feedbackHtml += "<p>아마도... 첫 번째 사람은 다른 빵을 골랐을 거고요. (다른 빵 선택 확률 50%)</p>";
                    if (person2Buys) {
                        breadWouldHaveBeenAvailable = false;
                        feedbackHtml += "<p>그렇다면 두 번째 사람이 그 초코 크림빵을 사갔을 겁니다! (선택 확률 50%)</p>";
                    } else {
                        feedbackHtml += "<p>두 번째 사람도 다른 빵을 골랐을 가능성이 높네요! (다른 빵 선택 확률 50%)</p>";
                    }
                }
                if (breadWouldHaveBeenAvailable) {
                    feedbackHtml += "<p>만약 줄을 계속 섰다면, 당신 차례까지 빵이 남아있었을 확률(25%)이 현실이 되었을 수도 있겠네요!</p>";
                     feedbackHtml += "<p class='player-thought'>참고: 내가 초코 크림빵을 살 수 있었던 경우는 첫 번째 사람이 다른 빵을 사고(1/2 확률), 두 번째 사람도 다른 빵을 사는 경우(1/2 확률)이므로 그 확률은 1/2 × 1/2 = 1/4 (25%)입니다.</p>";
                } else {
                    feedbackHtml += "<p>만약 줄을 계속 섰더라도, 앞사람 중 누군가가 빵을 사갔을 확률(75%) 때문에 당신은 빵을 얻지 못했을 거예요.</p>";
                    feedbackHtml += "<p class='player-thought'>참고: 내가 빵을 살 수 없었을 경우는 앞사람 중 적어도 한 명이 빵을 사는 경우입니다. 이는 전체 확률 1에서 두 사람 모두 빵을 사지 않을 확률(1/4)을 뺀 3/4 (75%)에 해당합니다.</p>";
                }
                endingText = "[하굣길 빵집에서 초코 크림빵을 사지 않고 집으로 돌아왔다. 그 빵은 다른 누군가의 차지가 되었을 것이다.]";
            }
        }
        else if (screenNum === 6) { 
            const probSumiNotComes = 0.5; 
            const probJieunNotComes = 2/3; 
            const probBothNotCome = probSumiNotComes * probJieunNotComes;

            let sumiActuallyComes = Math.random() < 0.5;
            let jieunActuallyComes = Math.random() < (1/3);

            if (choice === 'A') { 
                playerStats.librarySecretSuccess = !sumiActuallyComes && !jieunActuallyComes;
                feedbackHtml = "<h4>결과: 도서관 잠입 시도!</h4>";
                feedbackHtml += `<p>수미가 없을 확률(${probSumiNotComes*100}%) × 지은이가 없을 확률(${Math.round(probJieunNotComes*1000)/10}%) = 둘 다 없을 확률 약 <span class="highlight">${Math.round(probBothNotCome*1000)/10}%</span></p>`;
                feedbackHtml += "<hr><p>실제 도서관 상황은...</p>";

                if (playerStats.librarySecretSuccess) {
                    feedbackHtml += "<p>🎉 **잠입 성공!** 🎉 다행히 수미도 지은이도 도서관에 없었습니다. 당신은 평화롭게 도서관을 이용했습니다!</p>";
                    endingText = "[하굣길, 친구들 몰래 도서관에 갔는데 아무도 마주치지 않고 조용히 시간을 보낼 수 있었다.]";
                    effectType = 'good';
                } else {
                    feedbackHtml += "<p>아뿔싸! 잠입 실패!</p>";
                    if (sumiActuallyComes && jieunActuallyComes) {
                        feedbackHtml += "<p>수미와 지은이 둘 다 도서관에 있었습니다! 결국 마주치고 말았네요.</p>";
                        endingText = "[하굣길, 친구들 몰래 도서관에 갔지만 결국 수미와 지은이 둘 다 마주치고 말았다.]";
                    } else if (sumiActuallyComes) {
                        feedbackHtml += "<p>수미가 도서관에 있었습니다! 결국 수미와 마주쳤습니다.</p>";
                        endingText = "[하굣길, 친구들 몰래 도서관에 갔지만 결국 수미와 마주치고 말았다.]";
                    } else { 
                        feedbackHtml += "<p>지은이가 도서관에 있었습니다! 결국 지은이와 마주쳤습니다.</p>";
                        endingText = "[하굣길, 친구들 몰래 도서관에 갔지만 결국 지은이와 마주치고 말았다.]";
                    }
                    effectType = 'bad';
                }
            } else { 
                playerStats.librarySecretSuccess = null; 
                let secretVisitWouldHaveSucceeded = !sumiActuallyComes && !jieunActuallyComes; 

                feedbackHtml = "<h4>결과: 집으로...</h4><p>당신은 하굣길에 도서관에 들르지 않고 바로 집으로 가기로 했습니다.</p>";
                feedbackHtml += "<p class='player-thought'>만약 도서관에 몰래 갔다면 어땠을까요?</p>";
                feedbackHtml += `<p>수미가 없을 확률(${probSumiNotComes*100}%) × 지은이가 없을 확률(${Math.round(probJieunNotComes*1000)/10}%) = 둘 다 없을 확률 약 <span class="highlight">${Math.round(probBothNotCome*1000)/10}%</span></p>`;
                feedbackHtml += "<hr><p>실제 (당신이 안 간) 도서관 상황 추측...</p>";

                if (secretVisitWouldHaveSucceeded) {
                    feedbackHtml += "<p>아마도... 수미도 지은이도 없어서 조용히 이용할 수 있었을 거예요! (당신이 갔다면 잠입 성공)</p>";
                } else {
                    feedbackHtml += "<p>아마도... ";
                    if (sumiActuallyComes && jieunActuallyComes) {
                        feedbackHtml += "수미와 지은이 둘 다 있어서 마주쳤을 가능성이 높았겠네요.";
                    } else if (sumiActuallyComes) {
                        feedbackHtml += "수미가 있어서 마주쳤을 거예요.";
                    } else { 
                        feedbackHtml += "지은이가 있어서 마주쳤을 거예요.";
                    }
                    feedbackHtml += " 안 가길 잘한 걸까요? (당신이 갔다면 잠입 실패)</p>";
                }
                endingText = "[하굣길, 도서관에 들르지 않고 바로 집으로 왔다. 그곳에서 친구들과 마주쳤을지 아닐지는 모르는 일이다.]";
            }
        }

        if (endingText) endingTexts.push(endingText);
        
        if (effectType) { 
            triggerEffect(effectType);
        }

        if (screenNum !== 2) { 
            displayImmediateFeedback(screenNum, feedbackHtml, showMainNextBtn);
        }
    }

    function proceedToNext(prevScreenNum) {
        const feedbackDiv = document.getElementById('feedback' + prevScreenNum);
        const nextButton = document.getElementById('nextBtn' + prevScreenNum);
        if(feedbackDiv) feedbackDiv.innerHTML = "";
        if(nextButton) nextButton.style.display = 'none';
        
        if (prevScreenNum === 2) {
            const initialChoices2 = document.getElementById('choices2_initial');
            if (initialChoices2) {
                initialChoices2.style.display = 'block'; 
                initialChoices2.querySelectorAll('button').forEach(button => {
                    button.disabled = false; 
                });
            }
        } else {
            disableChoiceButtons('screen' + prevScreenNum, false);
        }

        currentScreenNum++;
        if (currentScreenNum > 6) {
            displayEnding();
        } else {
            showScreen(currentScreenNum);
            updateMoneyDisplay();
            disableChoiceButtons(currentScreenNum, false);
            if (currentScreenNum === 2) {
                 const initialChoices2 = document.getElementById('choices2_initial');
                 if (initialChoices2) initialChoices2.style.display = 'block';
                 disableChoiceButtons('screen2', false);
            }
        }
    }

    function displayEnding() {
        showScreen('Ending');
        const endingOutput = document.getElementById('endingTextOutput');
        let fullEndingText = "<p><strong>나의 선택들이 모여 이런 하루가 되었어요...</strong></p>";
        endingTexts.forEach(text => {
            fullEndingText += `<p>${text}</p>`;
        });

        if (playerStats.lotteryAttempts > 0) {
            if (playerStats.lotteryPrize) {
                fullEndingText += `<p>[뽑기 요약: 총 ${playerStats.lotterySpent}원을 사용하여 ${playerStats.lotteryAttempts}번의 도전 끝에 <span class="highlight">10%</span>의 확률을 뚫고 상품을 얻었다!]</p>`;
            } else {
                fullEndingText += `<p>[뽑기 요약: 총 ${playerStats.lotterySpent}원을 사용하고 ${playerStats.lotteryAttempts}번 도전했지만, 아쉽게도 <span class="highlight">10%</span>의 확률 앞에서 상품을 얻지 못했다.]</p>`;
            }
        } else if (document.getElementById('screen2') && !document.getElementById('screen2').classList.contains('active') && currentScreenNum > 2 && !endingTexts.find(txt => txt.includes("뽑기 확률 앞에서 도전을 포기"))) {
             if(money < 100 && playerStats.lotteryAttempts === 0 && !playerStats.lotteryPrize && !endingTexts.find(txt => txt.includes("도전을 포기하고 돈을 아꼈다."))) { 
                fullEndingText += "<p>[뽑기: (등굣길) 돈이 부족하여 시도조차 하지 못했다.]</p>";
             }
        }


        fullEndingText += "<hr><p><strong>[하루 요약 및 상태]</strong></p>";
        fullEndingText += `<p>최종 소지금: ${money}원</p>`;
        if(playerStats.hasUmbrella) fullEndingText += "<p>- 챙겨간 우산이 있었다.</p>";
        if(playerStats.gotChocoBread) fullEndingText += "<p>- 맛있는 초코 크림빵을 먹었다!</p>";
        if(playerStats.latePenalty) fullEndingText += "<p>- 지각으로 선생님께 꾸중을 들었다.</p>";
        
        const screen4Element = document.getElementById('screen4');
        if (screen4Element && !screen4Element.classList.contains('active') && currentScreenNum > 4) { 
            if(playerStats.quizCorrect) fullEndingText += "<p>- 시험에서 찍은 문제가 정답이었다!</p>";
            else fullEndingText += "<p>- 시험에서 찍은 문제는 틀렸다.</p>";
        }
        if (playerStats.librarySecretSuccess === true) {
            fullEndingText += "<p>- 도서관 잠입에 성공하여 조용히 시간을 보냈다.</p>";
        } else if (playerStats.librarySecretSuccess === false) {
            fullEndingText += "<p>- 도서관 잠입에 실패하여 친구(들)와 마주쳤다.</p>";
        }


        endingOutput.innerHTML = fullEndingText;
    }

    function restartGame() {
        currentScreenNum = 1;
        money = 1000;
        endingTexts = [];
        playerStats = {
            hasUmbrella: false,
            lotteryPrize: false,
            lotteryAttempts: 0,
            lotterySpent: 0,
            gotChocoBread: false,
            latePenalty: false,
            quizCorrect: false,
            librarySecretSuccess: null
        };
        initializeGame(); 
    }

    // Ensure this is called after the DOM is loaded or place the script at the end of the body
    window.onload = initializeGame; 
</script>

</body>
</html>