<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™•ë¥  ì˜ì‚¬ê²°ì • ê²Œì„</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        .game-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .game-screen {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .game-screen.active {
            display: block;
        }
        .screen-title {
            font-size: 1.5em;
            color: #007bff;
            margin-bottom: 5px;
        }
        .location {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }
        .situation, .dilemma {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .choices button, .feedback-actions button {
            display: inline-block; 
            width: auto; 
            padding: 10px 15px; 
            margin: 5px; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .choices button.full-width { 
            display: block;
            width: 100%;
        }
        .choices button:hover, .feedback-actions button:hover {
            background-color: #0056b3;
        }
        .choices button:disabled, .feedback-actions button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .player-thought {
            font-style: italic;
            color: #555;
            margin-top: 10px;
            padding: 8px;
            background-color: #e9e9e9;
            border-radius: 3px;
        }
        .immediate-feedback {
            margin-top: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-left: 3px solid #007bff;
            border-radius: 3px;
        }
        .immediate-feedback h4 {
            margin-top: 0;
            color: #0056b3;
        }
        .next-button { 
            display: none; 
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .next-button:hover {
            background-color: #218838;
        }
        #endingScreen .ending-text {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border-left: 5px solid #4caf50;
        }
        .highlight {
            font-weight: bold;
            color: #d9534f; 
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-effect {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes good-flash {
            0%, 100% { background-color: #f9f9f9; border-left-color: #007bff; }
            50% { background-color: #d4edda; border-left-color: #28a745; } 
        }
        .good-outcome-flash { 
            animation: good-flash 0.8s ease-out;
        }

    </style>
</head>
<body>

<div class="game-container">
    <h1>ë‚˜ì˜ ì„ íƒì€?</h1>

    <div id="screen1" class="game-screen active">
        <h2 class="screen-title">ì„ íƒ 1: ì•„ì¹¨, ìš°ì‚°ê³¼ì˜ ëˆˆì¹˜ ì‹¸ì›€</h2>
        <p class="location">ğŸ“ ì¥ì†Œ: ì•„ì¹¨, í˜„ê´€ ì•</p>
        <p class="situation">
            TVì—ì„œ ì•„ë‚˜ìš´ì„œì˜ ëª©ì†Œë¦¬ê°€ í˜ëŸ¬ë‚˜ì˜¨ë‹¤.<br>
            "ì˜¤ëŠ˜ ì „êµ­ì ìœ¼ë¡œ ë¹„ ì†Œì‹ì´ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ ì˜ˆìƒ ê°•ìˆ˜ í™•ë¥ ì€ <span id="rainChance" class="highlight">[xx]</span>%ì…ë‹ˆë‹¤."<br>
            ì°½ë°–ì„ ë³´ë‹ˆ í•˜ëŠ˜ì€ ì•„ì§ íë¦¬ê¸°ë§Œ í•˜ë‹¤.
        </p>
        <p class="dilemma">ğŸ¤” ë‹¹ì‹ ì˜ ê³ ë¯¼: ìš°ì‚°ì„ ê°€ì ¸ê°ˆê¹Œ, ë§ê¹Œ?</p>
        <div class="choices">
            <button class="full-width" id="s1c1" onclick="handleChoice('screen1', 'A')">A) í˜¹ì‹œ ëª¨ë¥´ë‹ˆ, ì±™ê²¨ ë‚˜ê°„ë‹¤.</button>
            <button class="full-width" id="s1c2" onclick="handleChoice('screen1', 'B')">B) ì´ ì •ë„ í™•ë¥ ì´ë©´ ê´œì°®ì•„, ê·¸ëƒ¥ ë‚˜ê°„ë‹¤.</button>
        </div>
        <div class="immediate-feedback" id="feedback1"></div>
        <button class="next-button" id="nextBtn1" onclick="proceedToNext(1)">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>

    <div id="screen2" class="game-screen">
        <h2 class="screen-title">ì„ íƒ 2: ê¸¸ê°€ì˜ ìœ í˜¹, 10%ì˜ ë„ì „</h2>
        <p class="location">ğŸ“ ì¥ì†Œ: ë“±êµ£ê¸¸, ë¬¸êµ¬ì  ì•</p>
        <p class="situation">
            ë“±êµ£ê¸¸, ë¬¸êµ¬ì  ì•ì— ë†“ì¸ ìƒí’ˆ ë½‘ê¸° ê¸°ê³„ê°€ ì‹œì„ ì„ ì‚¬ë¡œì¡ëŠ”ë‹¤.<br>
            "âœ¨ì¸ê¸° ìºë¦­í„° í•œì •íŒ ì¸í˜• íšë“ ì°¬ìŠ¤!âœ¨ ë‹¨ëˆ 100ì›! ì„±ê³µ í™•ë¥  <span class="highlight">10%</span>!"<br>
            (í˜„ì¬ ë‚´ ì§€ê°‘ì—ëŠ” <span id="currentMoneyLottery" class="highlight">[í˜„ì¬ ì†Œì§€ê¸ˆ]</span>ì›ì´ ìˆë‹¤.)
        </p>
        <p class="dilemma">ğŸ¤” ë‹¹ì‹ ì˜ ê³ ë¯¼: 10%ì˜ í™•ë¥ ... í•œë²ˆ ë„ì „í•´ ë³¼ê¹Œ?</p>
        <div class="player-thought">"10%ë©´... ì—´ ë²ˆ ì¤‘ í•œ ë²ˆì€ ë˜ì§€ ì•Šì„ê¹Œ?" (ë‚´ì  ê³ ë¯¼)</div>
        <div class="choices" id="choices2_initial">
            <button class="full-width" id="s2c1_initial" onclick="handleLotteryChoice('initial_try')">A) ì¢‹ì•„, 10%ì˜ í–‰ìš´ì— ë„ì „í•œë‹¤! (100ì› ì°¨ê°)</button>
            <button class="full-width" id="s2c2_initial" onclick="handleLotteryChoice('initial_pass')">B) ìœ¼ìŒ... ê·¸ë˜ë„ ì‹¤íŒ¨í•  ê²ƒ ê°™ì•„. ê·¸ëƒ¥ ì§€ë‚˜ê°€ì.</button>
        </div>
        <div class="immediate-feedback" id="feedback2">
        </div>
        <button class="next-button" id="nextBtn2" onclick="proceedToNext(2)" style="display:none;">ë‹¤ìŒ í™”ë©´ìœ¼ë¡œ</button>
    </div>

    <div id="screen3" class="game-screen">
        <h2 class="screen-title">ì„ íƒ 3: ì§€ê° ìœ„ê¸°! ì •ë¬¸ vs í›„ë¬¸</h2>
        <p class="location">ğŸ“ ì¥ì†Œ: ì•„ìŠ¬ì•„ìŠ¬ ë“±êµ£ê¸¸, í•™êµ ì•</p>
        <p class="situation">
            ì´ëŸ°, ì•„ì¹¨ë¶€í„° ë¬¸êµ¬ì  ì• ë½‘ê¸° ê¸°ê³„ì— í•œëˆˆì„ íŒ”ë‹¤ê°€ ê·¸ë§Œ ë“±êµ ì‹œê°„ì— ëŠ¦ì–´ë²„ë ¸ë‹¤!<br> 
            í—ˆê²ì§€ê² í•™êµ ì•ì— ë„ì°©í•˜ë‹ˆ ì´ë¯¸ ìˆ˜ì—… ì‹œì‘ ì¢…ì´ ìš¸ë¦° ê²ƒ ê°™ë‹¤.<br>
            ì •ë¬¸ìœ¼ë¡œ ë‹¹ë‹¹íˆ ë“¤ì–´ê°ˆê¹Œ, ì•„ë‹ˆë©´ í›„ë¬¸ìœ¼ë¡œ ëª°ë˜ ë“¤ì–´ê°ˆê¹Œ?<br>
            ì˜¤ëŠ˜ì€ ìœ ë‚œíˆ ì„ ìƒë‹˜ë“¤ì´ ì§€ê°ìƒì„ ì¡ì„ ê²ƒ ê°™ì€ ë¶ˆê¸¸í•œ ì˜ˆê°ì´ ìŠ¤ì¹œë‹¤.<br>
            (êµì¥ ì„ ìƒë‹˜ì˜ íŠ¹ë³„ ì§€ì‹œë¡œ, ì˜¤ëŠ˜ ì •ë¬¸ê³¼ í›„ë¬¸ ì¤‘ <span class="highlight">í•œ ê³³ì—ì„œë§Œ</span> ì„ ìƒë‹˜ì´ ì§€ê° ë‹¨ì†ì„ í•˜ì‹ ë‹¤!)
        </p>
        <p class="dilemma">ğŸ¤” ë‹¹ì‹ ì˜ ê³ ë¯¼: ì–´ëŠ ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°€ì•¼ ë¬´ì‚¬í• ê¹Œ? ë‚˜ì˜ ì„ íƒì€?</p>
        <div class="choices">
            <button class="full-width" id="s3c1" onclick="handleChoice('screen3', 'A')">A) ì •ë©´ ëŒíŒŒ! ì •ë¬¸ìœ¼ë¡œ ê°€ì!</button>
            <button class="full-width" id="s3c2" onclick="handleChoice('screen3', 'B')">B) ì€ë°€í•˜ê²Œ... í›„ë¬¸ìœ¼ë¡œ ê°€ì.</button>
        </div>
        <div class="immediate-feedback" id="feedback3"></div>
        <button class="next-button" id="nextBtn3" onclick="proceedToNext(3)">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>

    <div id="screen4" class="game-screen">
        <h2 class="screen-title">ì„ íƒ 4: ì‹œí—˜ ì‹œê°„, ë§ˆì§€ë§‰ í•œ ë¬¸ì œ</h2>
        <p class="location">ğŸ“ ì¥ì†Œ: ì‹œí—˜ ì‹œê°„ - êµì‹¤</p>
        <p class="situation">
            ì‹œí—˜ ì¢…ë£Œ 5ë¶„ ì „. ë§ˆì§€ë§‰ ë¬¸ì œë¥¼ ë¶™ì¡ê³  ìˆì§€ë§Œ... ì•„, ë„ì €íˆ ëª¨ë¥´ê² ë‹¤!<br>
            í•˜ì§€ë§Œ í¬ê¸°í•  ìˆœ ì—†ì§€. ë‹µì€ 4ê°œì˜ ì„ íƒì§€ ì¤‘ í•˜ë‚˜!
        </p>
        <p class="dilemma">ğŸ¤” ë‹¹ì‹ ì˜ ê³ ë¯¼: ì–´ë–¤ ë²ˆí˜¸ë¡œ ì°ì–´ì•¼ í• ê¹Œ? ë‚˜ì˜ ì§ê°ì„ ë¯¿ì–´ë³´ì!</p>
        <div class="choices">
            <button class="full-width" id="s4c1" onclick="handleChoice('screen4', 'A')">A) ì™ ì§€ ëŠë‚Œì´ ì˜¤ëŠ” 1ë²ˆ!</button>
            <button class="full-width" id="s4c2" onclick="handleChoice('screen4', 'B')">B) ê°€ì¥ ì•ˆ ë‚˜ì˜¬ ê²ƒ ê°™ì€ 2ë²ˆ!</button>
            <button class="full-width" id="s4c3" onclick="handleChoice('screen4', 'C')">C) ë‚˜ì˜ í–‰ìš´ì˜ ìˆ«ì 3ë²ˆ!</button>
            <button class="full-width" id="s4c4" onclick="handleChoice('screen4', 'D')">D) ëª¨ë¥´ê² ì„ ë• ë§ˆì§€ë§‰ ë²ˆí˜¸ 4ë²ˆ!</button>
        </div>
        <div class="immediate-feedback" id="feedback4"></div>
        <button class="next-button" id="nextBtn4" onclick="proceedToNext(4)">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>

    <div id="screen5" class="game-screen">
        <h2 class="screen-title">ì„ íƒ 5: ë¹µì§‘ì˜ ìš´ëª…, ë§ˆì§€ë§‰ ì´ˆì½” í¬ë¦¼ë¹µ</h2>
        <p class="location">ğŸ“ ì¥ì†Œ: í•˜êµ£ê¸¸, ë™ë„¤ ë¹µì§‘</p> 
        <p class="situation">
            í•˜êµ£ê¸¸, ë‚´ê°€ ì œì¼ ì¢‹ì•„í•˜ëŠ” ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ëŸ¬ ë¹µì§‘ì— ì™”ë‹¤.<br> 
            ê·¸ëŸ°ë°... ë‚´ ì•ì— ì´ë¯¸ ë‘ ëª…ì´ ì¤„ì„ ì„œ ìˆê³ , ì§„ì—´ëŒ€ì—ëŠ” ì´ˆì½” í¬ë¦¼ë¹µì´ <span class="highlight">ë”± í•œ ê°œ</span> ë‚¨ì•„ìˆë‹¤!<br>
            ì• ì‚¬ëŒë“¤ì€ ë¹µì„ í•˜ë‚˜ì”©ë§Œ ì‚´ ì˜ˆì •ì´ê³ , ê°ì ì´ ì´ˆì½” í¬ë¦¼ë¹µì„ ê³ ë¥¼ í™•ë¥ ì€ <span class="highlight">50%</span>ë¼ê³  í•œë‹¤.
        </p>
        <p class="dilemma">ğŸ¤” ë‹¹ì‹ ì˜ ê³ ë¯¼: ì´ ì¤„, ê³„ì† ì„œì•¼ í• ê¹Œ? ì•„ë‹ˆë©´ ê·¸ëƒ¥ ì§‘ì— ê°ˆê¹Œ?</p>
        <div class="choices">
            <button class="full-width" id="s5c1" onclick="handleChoice('screen5', 'A')">A) ë§ˆì§€ë§‰ í¬ë§ì„ ê±¸ê³  ê¸°ë‹¤ë ¤ë³¸ë‹¤!</button>
            <button class="full-width" id="s5c2" onclick="handleChoice('screen5', 'B')">B) ì´ˆì½” í¬ë¦¼ë¹µ ì•ˆ ì‚¬ê³  ê·¸ëƒ¥ ì§‘ì— ê°„ë‹¤.</button> 
        </div>
        <div class="immediate-feedback" id="feedback5"></div>
        <button class="next-button" id="nextBtn5" onclick="proceedToNext(5)">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>

    <div id="screen6" class="game-screen">
        <h2 class="screen-title">ì„ íƒ 6: ë„ì„œê´€ ì ì… ì‘ì „</h2>
        <p class="location">ğŸ“ ì¥ì†Œ: í•˜êµ£ê¸¸</p> 
        <p class="situation">
            í•˜êµ£ê¸¸, ì¡°ìš©íˆ ì±…ì„ ì½ê³  ì‹¶ì€ë° í˜¹ì‹œ ë„ì„œê´€ì—ì„œ ì¹œêµ¬ë“¤ì„ ë§ˆì£¼ì¹ ê¹Œ ê±±ì •ì´ë‹¤.<br> 
            ìˆ˜ë¯¸ê°€ ì˜¤ëŠ˜ ë„ì„œê´€ì— ì˜¬ í™•ë¥ ì€ <span class="highlight">50%</span>, ì§€ì€ì´ê°€ ì˜¬ í™•ë¥ ì€ ì•½ <span class="highlight">33%</span>(1/3)ì´ë¼ê³  í•œë‹¤.<br>
            ë‘˜ ë‹¤ ë§ˆì£¼ì¹˜ì§€ ì•Šê³  ëª°ë˜ ë„ì„œê´€ì„ ì´ìš©í•˜ê³  ì‹¶ë‹¤!
        </p>
        <p class="dilemma">ğŸ¤” ë‹¹ì‹ ì˜ ê³ ë¯¼: ë„ì„œê´€ì— ëª°ë˜ ê°€ ë³¼ê¹Œ?</p>
        <div class="choices">
            <button class="full-width" id="s6c1" onclick="handleChoice('screen6', 'A')">A) ê·¸ë˜, ì¡°ìš©íˆ ë„ì„œê´€ì— ê°€ë³´ì!</button>
            <button class="full-width" id="s6c2" onclick="handleChoice('screen6', 'B')">B) ì•„ë‹ˆì•¼, ê·¸ëƒ¥ ì•ˆì „í•˜ê²Œ ì§‘ìœ¼ë¡œ ê°€ì.</button>
        </div>
        <div class="immediate-feedback" id="feedback6"></div>
        <button class="next-button" id="nextBtn6" onclick="proceedToNext(6)">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>

    <div id="endingScreen" class="game-screen">
        <h2 class="screen-title">ë‚˜ì˜ í•˜ë£¨ ëŒì•„ë³´ê¸°</h2>
        <div id="endingTextOutput" class="ending-text">
            <p>ë‚˜ì˜ ì„ íƒë“¤ì´ ëª¨ì—¬ ì´ëŸ° í•˜ë£¨ê°€ ë˜ì—ˆì–´ìš”...</p>
        </div>
        <div class="choices">
            <button class="full-width" onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    let currentScreenNum = 1;
    let money = 1000;
    const chocoBreadPrice = 1000;
    let rainChancePercentage = 0;
    let endingTexts = [];
    let playerStats = {
        hasUmbrella: false,
        lotteryPrize: false,
        lotteryAttempts: 0,
        lotterySpent: 0,
        gotChocoBread: false,
        latePenalty: false,
        quizCorrect: false,
        librarySecretSuccess: null 
    };

    const gameContainerElement = document.querySelector('.game-container');

    function triggerEffect(type) {
        const activeScreen = document.getElementById('screen' + currentScreenNum); 
        if (!activeScreen && currentScreenNum !== 'Ending') return; 

        const feedbackDiv = activeScreen ? activeScreen.querySelector('.immediate-feedback') : null;

        if (type === 'bad') {
            gameContainerElement.classList.add('shake-effect');
            setTimeout(() => {
                gameContainerElement.classList.remove('shake-effect');
            }, 500); 
        } else if (type === 'good' && feedbackDiv) {
            feedbackDiv.classList.add('good-outcome-flash');
            setTimeout(() => {
                feedbackDiv.classList.remove('good-outcome-flash');
            }, 800); 
        }
    }


    function initializeGame() {
        rainChancePercentage = Math.floor(Math.random() * 81) + 10;
        document.getElementById('rainChance').textContent = rainChancePercentage;
        updateMoneyDisplay();
        for (let i = 1; i <= 6; i++) {
            disableChoiceButtons('screen' + i, false); 
            const feedbackDiv = document.getElementById('feedback' + i);
            const nextButton = document.getElementById('nextBtn' + i);
            if(feedbackDiv) feedbackDiv.innerHTML = "";
            if(nextButton) nextButton.style.display = 'none';
        }
        const choices2Initial = document.getElementById('choices2_initial');
        if(choices2Initial) choices2Initial.style.display = 'block';
        showScreen(currentScreenNum);
    }

    function showScreen(screenNumber) {
        document.querySelectorAll('.game-screen').forEach(screen => {
            screen.classList.remove('active');
        });
        const targetScreen = document.getElementById(screenNumber === 'Ending' ? 'endingScreen' : 'screen' + screenNumber);
        if(targetScreen) {
            targetScreen.classList.add('active');
        }
    }

    function updateMoneyDisplay() {
        const moneyDisplayLottery = document.getElementById('currentMoneyLottery');
        if (moneyDisplayLottery) moneyDisplayLottery.textContent = money;
    }

    function disableChoiceButtons(screenIdOrNum, disable = true) {
        const screenId = (typeof screenIdOrNum === 'string') ? screenIdOrNum : 'screen' + screenIdOrNum;
        const screen = document.getElementById(screenId);
        if (screen) {
            const choiceDiv = screen.querySelector('.choices'); 
            if(choiceDiv) {
                choiceDiv.querySelectorAll('button').forEach(button => {
                    button.disabled = disable;
                });
            }
            if (screenId === 'screen2') {
                const initialChoices2 = document.getElementById('choices2_initial');
                if (initialChoices2) {
                    initialChoices2.querySelectorAll('button').forEach(button => {
                        button.disabled = disable;
                    });
                }
            }
        }
    }

    function showNextButton(screenNum, show = true) {
         const nextButton = document.getElementById('nextBtn' + screenNum);
         if(nextButton) {
            nextButton.style.display = show ? 'block' : 'none';
         }
    }

    function displayImmediateFeedback(screenNum, feedbackHtml, showMainNextBtn = false) {
        const feedbackDiv = document.getElementById('feedback' + screenNum);
        if(feedbackDiv){
            feedbackDiv.innerHTML = feedbackHtml;
        }
        if (screenNum !== 2) { 
            disableChoiceButtons(screenNum, true);
        }
        if(showMainNextBtn) {
             showNextButton(screenNum, true);
        }
    }

    function handleLotteryChoice(action) {
        const feedbackDiv = document.getElementById('feedback2');
        const initialChoicesDiv = document.getElementById('choices2_initial');
        const mainNextButton = document.getElementById('nextBtn2');
        let feedbackHtml = "";

        if(initialChoicesDiv) initialChoicesDiv.style.display = 'none';
        mainNextButton.style.display = 'none';

        if (action === 'initial_pass') {
            feedbackHtml = "<h4>ê²°ê³¼: ë„ì „ í¬ê¸°</h4><p>ì„±ê³µ í™•ë¥  10%ëŠ” ì—¬ì „íˆ ë‚®ë‹¤ê³  íŒë‹¨í•˜ì—¬, ì‹ ì¤‘í•˜ê²Œ ëˆì„ ì•„ë¼ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.</p>";
            endingTexts.push("[10%ì˜ ë½‘ê¸° í™•ë¥  ì•ì—ì„œ ë„ì „ì„ í¬ê¸°í•˜ê³  ëˆì„ ì•„ê¼ˆë‹¤.]");
            feedbackDiv.innerHTML = feedbackHtml;
            showNextButton(2, true); 
        } else if (action === 'initial_try' || action === 'retry') {
            if (money >= 100) {
                money -= 100;
                playerStats.lotteryAttempts++;
                playerStats.lotterySpent += 100;
                updateMoneyDisplay();
                let success = Math.random() < 0.10; 

                if (success) {
                    playerStats.lotteryPrize = true;
                    feedbackHtml = `<h4>ê²°ê³¼: ğŸ‰ ëŒ€ì„±ê³µ! (${playerStats.lotteryAttempts}ë²ˆì§¸ ì‹œë„) ğŸ‰</h4><p>ìƒí’ˆ ë½‘ê¸° ì„±ê³µ í™•ë¥  <span class="highlight">10%</span>ì— ë„ì „í•˜ì—¬, ë“œë””ì–´ ìƒí’ˆì„ ë½‘ì•˜ìŠµë‹ˆë‹¤! ì´ ${playerStats.lotterySpent}ì›ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.</p>`;
                    triggerEffect('good');
                    feedbackDiv.innerHTML = feedbackHtml;
                    showNextButton(2, true); 
                } else {
                    feedbackHtml = `<h4>ê²°ê³¼: ê½! (ì‹œë„ íšŸìˆ˜: ${playerStats.lotteryAttempts}, ë‚¨ì€ ëˆ: ${money}ì›)</h4><p>ìƒí’ˆ ë½‘ê¸° ì„±ê³µ í™•ë¥  <span class="highlight">10%</span>ì— ë„ì „í–ˆì§€ë§Œ, ì•„ì‰½ê²Œë„ 90%ì˜ ì‹¤íŒ¨ í™•ë¥ ì´ ë” ë†’ì•˜ë„¤ìš”. 100ì›ì„ ìƒì—ˆìŠµë‹ˆë‹¤.</p>`;
                    triggerEffect('bad');
                    if (money >= 100) {
                        feedbackHtml += `<div class="feedback-actions"><button onclick="handleLotteryChoice('retry')">ë‹¤ì‹œ ë„ì „í•œë‹¤! (100ì› ì‚¬ìš©)</button> <button onclick="quitLotteryAndProceed()">ê·¸ë§Œí•˜ê³  ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.</button></div>`;
                    } else {
                        feedbackHtml += "<p>ëˆì´ ë¶€ì¡±í•˜ì—¬ ë” ì´ìƒ ë„ì „í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
                        feedbackHtml += `<div class="feedback-actions"><button onclick="quitLotteryAndProceed()">ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°„ë‹¤.</button></div>`;
                    }
                    feedbackDiv.innerHTML = feedbackHtml;
                }
            } else {
                feedbackHtml = "<h4>ê²°ê³¼: ì‹œë„ ì‹¤íŒ¨!</h4><p>ë½‘ê¸°ì— ë„ì „í•˜ê³  ì‹¶ì—ˆì§€ë§Œ, ì•„ì‰½ê²Œë„ ëˆì´ ë¶€ì¡±í•´ì„œ ì‹œë„ì¡°ì°¨ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
                triggerEffect('bad');
                feedbackDiv.innerHTML = feedbackHtml;
                showNextButton(2, true); 
            }
        }
    }

    function quitLotteryAndProceed() {
        proceedToNext(2);
    }

    function handleChoice(screenId, choice) {
        const screenNum = parseInt(screenId.replace('screen', ''));
        // í™”ë©´ 2ëŠ” handleLotteryChoiceì—ì„œ ì§ì ‘ ì²˜ë¦¬í•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì¼ë°˜ ë²„íŠ¼ í´ë¦­ ì‹œì—ëŠ” ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•Šë„ë¡ ìˆ˜ì •.
        // (ì´ˆê¸° ë²„íŠ¼ì—ì„œ handleLotteryChoiceë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½í–ˆê¸° ë•Œë¬¸)
        if (screenNum === 2 && (document.getElementById('s2c1_initial') && document.getElementById('s2c2_initial'))) {
             // ì´ ì¡°ê±´ì€ ì´ˆê¸° ë²„íŠ¼ë“¤ì´ handleLotteryChoiceë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ë¯€ë¡œ,
             // ì¼ë°˜ handleChoiceê°€ ì¤‘ë³µ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë°©ì§€í•˜ëŠ” ëª©ì .
             // í•˜ì§€ë§Œ, ë” ëª…í™•í•˜ê²ŒëŠ” screen2ì˜ ì´ˆê¸° ë²„íŠ¼ì€ onclick="handleLotteryChoice(...)"ë¥¼ ì‚¬ìš©í•˜ê³ 
             // handleChoiceì—ì„œëŠ” screenNum === 2 ì¼€ì´ìŠ¤ë¥¼ ì™„ì „íˆ ì œì™¸í•˜ê±°ë‚˜,
             // ì¬ë„ì „ ë“±ì˜ ë²„íŠ¼ì´ handleChoiceë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šë„ë¡ êµ¬ë¶„í•´ì•¼ í•©ë‹ˆë‹¤.
             // í˜„ì¬ êµ¬ì¡°ìƒ handleLotteryChoiceê°€ ì´ˆê¸° ë²„íŠ¼ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ, ì´ í•¨ìˆ˜ì—ì„œ screenNum === 2ë¥¼ ìŠ¤í‚µí•´ë„ ë¬´ë°©.
            return; 
        }


        let feedbackHtml = "";
        let endingText = "";
        let showMainNextBtn = true;
        let effectType = null; 

        if (screenNum === 1) {
            let actuallyRained = Math.random() * 100 < rainChancePercentage;
            feedbackHtml += `<h4>ê²°ê³¼: ${actuallyRained ? "ë¹„ê°€ ì‹¤ì œë¡œ ë‚´ë ¸ìŠµë‹ˆë‹¤!" : "ì˜¤ëŠ˜ì€ ë¹„ê°€ ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"}</h4>`;
            feedbackHtml += `<p>ì˜¤ëŠ˜ ë¹„ ì˜¬ í™•ë¥ ì€ ${rainChancePercentage}%ì˜€ìŠµë‹ˆë‹¤. ${actuallyRained ? "ê·¸ ê²°ê³¼, ì‹¤ì œë¡œë„ ë¹„ê°€ ë‚´ë ¸ìŠµë‹ˆë‹¤." : "ê·¸ ê²°ê³¼, ì‹¤ì œë¡œëŠ” ë¹„ê°€ ë‚´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}</p>`;
            
            if (choice === 'A') { 
                playerStats.hasUmbrella = true;
                if (actuallyRained) {
                    endingText = "[ë¹„ ì˜¤ëŠ” ë‚ , ìš°ì‚°ì„ ì±™ê²¨ê°„ ë•ë¶„ì— ë³´ì†¡ë³´ì†¡í•˜ê²Œ í•˜ë£¨ë¥¼ ë³´ëƒˆë‹¤.]";
                    feedbackHtml += `<p>ë‹¹ì‹ ì€ ìš°ì‚°ì„ ì±™ê²¼ìŠµë‹ˆë‹¤. í˜„ëª…í•œ ì„ íƒì´ì—ˆë„¤ìš”!</p>`;
                    effectType = 'good';
                } else {
                    endingText = "[ë§‘ì€ ë‚ , í˜¹ì‹œë‚˜ í•´ì„œ ì±™ê²¼ë˜ ìš°ì‚°ì´ ì¡°ê¸ˆ ë¬´ê±°ì› ì§€ë§Œ ê·¸ë˜ë„ ì•ˆì‹¬ì´ì—ˆë‹¤.]";
                    feedbackHtml += `<p>ë‹¹ì‹ ì€ ìš°ì‚°ì„ ì±™ê²¼ìŠµë‹ˆë‹¤. ì¡°ê¸ˆ ë²ˆê±°ë¡œì› ì„ ìˆ˜ë„ ìˆì§€ë§Œ, ëŒ€ë¹„ëŠ” ì¢‹ì€ ê±°ì£ !</p>`;
                }
            } else { 
                playerStats.hasUmbrella = false;
                if (actuallyRained) {
                    endingText = "[ë¹„ ì˜¤ëŠ” ë‚ , ìš°ì‚°ì„ ì•ˆ ê°€ì ¸ê°€ì„œ ê²°êµ­ ì˜ˆìƒì¹˜ ëª»í•œ ë¹„ì— ì«„ë”± ì –ê³  ë§ì•˜ë‹¤.]";
                    feedbackHtml += `<p>ë‹¹ì‹ ì€ ìš°ì‚°ì„ ì±™ê¸°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ëŸ°! ë¹„ë¥¼ ë§ê²Œ ë˜ì—ˆë„¤ìš”.</p>`;
                    effectType = 'bad';
                } else {
                    endingText = "[ë§‘ì€ ë‚ , ìš°ì‚°ì„ ì•ˆ ê°€ì ¸ê°„ ë‚˜ì˜ ê°€ë²¼ìš´ ë°œê±¸ìŒì€ íƒì›”í•œ ì„ íƒì´ì—ˆë‹¤!]";
                    feedbackHtml += `<p>ë‹¹ì‹ ì€ ìš°ì‚°ì„ ì±™ê¸°ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì˜ˆì¸¡ ì„±ê³µ! ê°€ë¿í•œ í•˜ë£¨!</p>`;
                    effectType = 'good';
                }
            }
        }
        else if (screenNum === 3) { 
            let teacherAtMainGate = Math.random() < 0.5; 
            let caught = false;
            feedbackHtml += `<h4>ê²°ê³¼: ì„ ìƒë‹˜ì€... ${teacherAtMainGate ? "ì •ë¬¸" : "í›„ë¬¸"}ì— ê³„ì…¨ìŠµë‹ˆë‹¤!</h4><p>(ê° ë¬¸ì— ì„ ìƒë‹˜ì´ ê³„ì‹¤ í™•ë¥ ì€ 50%ì˜€ìŠµë‹ˆë‹¤.)</p>`;

            if (choice === 'A') { 
                if (teacherAtMainGate) {
                    caught = true;
                    endingText = "[ë½‘ê¸° êµ¬ê²½í•˜ë‹¤ ëŠ¦ì–´ ì •ë¬¸ìœ¼ë¡œ ê°”ì§€ë§Œ, ê²°êµ­ ì„ ìƒë‹˜ê»˜ ë¶™ì¡í˜€ ë”°ë”í•œ í›ˆê³„ë¥¼ ë“¤ì–´ì•¼ í–ˆë‹¤.]";
                    feedbackHtml += "<p>ì´ëŸ°! ì •ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°”ë‹¤ê°€ ë‹¨ì†ì— ê±¸ë ¸ìŠµë‹ˆë‹¤!</p>";
                    effectType = 'bad';
                } else {
                    endingText = "[ë½‘ê¸° êµ¬ê²½í•˜ë‹¤ ëŠ¦ì—ˆì§€ë§Œ ì •ë¬¸ìœ¼ë¡œ í–¥í–ˆê³ , ë‹¤í–‰íˆ ì„ ìƒë‹˜ì´ ì•ˆ ê³„ì…”ì„œ ë¬´ì‚¬íˆ êµì‹¤ë¡œ ë“¤ì–´ê°”ë‹¤!]";
                    feedbackHtml += "<p>íœ´! ì •ë¬¸ì—ëŠ” ì„ ìƒë‹˜ì´ ì•ˆ ê³„ì…¨ë„¤ìš”. ë¬´ì‚¬ í†µê³¼!</p>";
                    effectType = 'good';
                }
            } else { 
                if (!teacherAtMainGate) { 
                    caught = true;
                    endingText = "[ë½‘ê¸° êµ¬ê²½í•˜ë‹¤ ëŠ¦ì–´ í›„ë¬¸ìœ¼ë¡œ ê°”ì§€ë§Œ, ê²°êµ­ ì„ ìƒë‹˜ì˜ ëˆˆì„ í”¼í•˜ì§€ ëª»í•˜ê³  ì”ì†Œë¦¬ë¥¼ ë“£ê²Œ ë˜ì—ˆë‹¤.]";
                    feedbackHtml += "<p>ì´ëŸ°! í›„ë¬¸ìœ¼ë¡œ ë“¤ì–´ê°”ë‹¤ê°€ ë‹¨ì†ì— ê±¸ë ¸ìŠµë‹ˆë‹¤!</p>";
                    effectType = 'bad';
                } else {
                    endingText = "[ë½‘ê¸° êµ¬ê²½í•˜ë‹¤ ëŠ¦ì—ˆì§€ë§Œ í›„ë¬¸ìœ¼ë¡œ í–¥í–ˆê³ , ë‹¤í–‰íˆ ì„ ìƒë‹˜ì´ ì•ˆ ê³„ì…”ì„œ ì¡°ìš©íˆ êµì‹¤ë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì—ˆë‹¤!]";
                    feedbackHtml += "<p>íœ´! í›„ë¬¸ì—ëŠ” ì„ ìƒë‹˜ì´ ì•ˆ ê³„ì…¨ë„¤ìš”. ë¬´ì‚¬ í†µê³¼!</p>";
                    effectType = 'good';
                }
            }
            playerStats.latePenalty = caught;
        }
        else if (screenNum === 4) { 
            let correctAnswer = Math.floor(Math.random() * 4) + 1; 
            let playerPick = 0;
            if (choice === 'A') playerPick = 1;
            else if (choice === 'B') playerPick = 2;
            else if (choice === 'C') playerPick = 3;
            else if (choice === 'D') playerPick = 4;

            playerStats.quizCorrect = (playerPick === correctAnswer);
            feedbackHtml = `<h4>ê²°ê³¼: ë‹¹ì‹ ì˜ ì„ íƒì€ ${playerPick}ë²ˆ!</h4><p>(ê° ì„ íƒì§€ê°€ ì •ë‹µì¼ í™•ë¥ ì€ 1/4 = 25%ì…ë‹ˆë‹¤.)</p>`;
            if (playerStats.quizCorrect) {
                feedbackHtml += `<p>ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰ ìš´ì´ ì¢‹ì•˜ë„¤ìš”!</p>`;
                endingText = `[ì‹œí—˜ ì¤‘ ëª¨ë¥´ëŠ” ë¬¸ì œëŠ” ${playerPick}ë²ˆìœ¼ë¡œ ì°ì—ˆëŠ”ë°, í–‰ìš´ì˜ ì—¬ì‹ ì´ í•¨ê»˜í–ˆëŠ”ì§€ ì •ë‹µì´ì—ˆë‹¤!]`;
                effectType = 'good';
            } else {
                feedbackHtml += `<p>ì•„ì‰½ì§€ë§Œ ì˜¤ë‹µì…ë‹ˆë‹¤. (ì •ë‹µì€ ${correctAnswer}ë²ˆì´ì—ˆìŠµë‹ˆë‹¤.)</p>`;
                endingText = `[ì‹œí—˜ ì¤‘ ëª¨ë¥´ëŠ” ë¬¸ì œëŠ” ${playerPick}ë²ˆìœ¼ë¡œ ì°ì—ˆì§€ë§Œ, ì•„ì‰½ê²Œë„ ì •ë‹µì„ í”¼í•´ê°”ë‹¤. (ì •ë‹µ:${correctAnswer}ë²ˆ)]`;
                effectType = 'bad';
            }
        }
        else if (screenNum === 5) { 
             if (choice === 'A') { 
                let person1Buys = Math.random() < 0.5; 
                let person2Buys = Math.random() < 0.5; 
                let breadAvailableForPlayer = true;

                feedbackHtml = "<h4>ê²°ê³¼: ë¹µì˜ í–‰ë°©ì€?</h4>"
                if (person1Buys) {
                    breadAvailableForPlayer = false;
                    feedbackHtml += "<p>ì²« ë²ˆì§¸ ì‚¬ëŒì´ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ê°”ìŠµë‹ˆë‹¤! (ì„ íƒ í™•ë¥  50%)</p>";
                } else {
                    feedbackHtml += "<p>ì²« ë²ˆì§¸ ì‚¬ëŒì€ ë‹¤ë¥¸ ë¹µì„ ê³¨ëìŠµë‹ˆë‹¤. (ë‹¤ë¥¸ ë¹µ ì„ íƒ í™•ë¥  50%)</p>";
                    if (person2Buys) {
                        breadAvailableForPlayer = false;
                        feedbackHtml += "<p>ì´ì–´ì„œ ë‘ ë²ˆì§¸ ì‚¬ëŒì´ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ê°”ìŠµë‹ˆë‹¤! (ì„ íƒ í™•ë¥  50%)</p>";
                    } else {
                        feedbackHtml += "<p>ë‘ ë²ˆì§¸ ì‚¬ëŒë„ ë‹¤ë¥¸ ë¹µì„ ê³¨ëìŠµë‹ˆë‹¤! (ë‹¤ë¥¸ ë¹µ ì„ íƒ í™•ë¥  50%)</p>";
                    }
                }

                if (breadAvailableForPlayer) {
                    feedbackHtml += "<p><strong>ê¸°íšŒ!</strong> ì•ì˜ ë‘ ì‚¬ëŒì´ ëª¨ë‘ ë‹¤ë¥¸ ë¹µì„ ê³ ë¥¼ í™•ë¥ (0.5 Ã— 0.5 = 0.25, ì¦‰ 25%)ì´ í˜„ì‹¤ì´ ë˜ì–´, ë“œë””ì–´ ë‹¹ì‹  ì°¨ë¡€ì…ë‹ˆë‹¤!</p>";
                    feedbackHtml += "<p class='player-thought'>ì°¸ê³ : ë‚´ê°€ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚´ ìˆ˜ ìˆëŠ” ê²½ìš°ëŠ” ì²« ë²ˆì§¸ ì‚¬ëŒì´ ë‹¤ë¥¸ ë¹µì„ ì‚¬ê³ (1/2 í™•ë¥ ), ë‘ ë²ˆì§¸ ì‚¬ëŒë„ ë‹¤ë¥¸ ë¹µì„ ì‚¬ëŠ” ê²½ìš°(1/2 í™•ë¥ )ì´ë¯€ë¡œ ê·¸ í™•ë¥ ì€ 1/2 Ã— 1/2 = 1/4 (25%)ì…ë‹ˆë‹¤.</p>"; 

                    if (money >= chocoBreadPrice) {
                        money -= chocoBreadPrice;
                        playerStats.gotChocoBread = true;
                        feedbackHtml += "<p>ğŸ‰ ì´ˆì½” í¬ë¦¼ë¹µì„ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤! ë§›ìˆê²Œ ë“œì„¸ìš”!</p>";
                        endingText = "[í•˜êµ£ê¸¸, ë¹µì§‘ ì¤„ì—ì„œ ê¸°ë‹¤ë¦° ëì— ë§ˆì§€ë§‰ ì´ˆì½” í¬ë¦¼ë¹µì„ ì°¨ì§€í•  ìˆ˜ ìˆì—ˆë‹¤! ì •ë§ ê¿€ë§›ì´ì—ˆë‹¤.]";
                        effectType = 'good';
                    } else {
                        feedbackHtml += "<p>ì´ëŸ°... ë¹µì€ ë‚¨ì•˜ì§€ë§Œ ëˆì´ ë¶€ì¡±í•´ì„œ ì‚´ ìˆ˜ê°€ ì—†ë„¤ìš”.</p>";
                        endingText = "[í•˜êµ£ê¸¸, ë¹µì§‘ì—ì„œ ë‚´ ì°¨ë¡€ê¹Œì§€ ë¹µì´ ë‚¨ì•„ ìˆì—ˆì§€ë§Œ, ëˆì´ ë¶€ì¡±í•´ì„œ ê²°êµ­ ì‚¬ì§€ ëª»í–ˆë‹¤. ë‹¤ë¥¸ ê³³ì— ì“°ì§€ ë§ ê±¸...]";
                        effectType = 'bad';
                    }
                } else {
                    feedbackHtml += "<p>ì•„ì‰½ê²Œë„ ì•ì‚¬ëŒ ì¤‘ ëˆ„êµ°ê°€ê°€ ë§ˆì§€ë§‰ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ ë²„ë ¸ìŠµë‹ˆë‹¤. (ëˆ„êµ°ê°€ ì‚´ í™•ë¥  75%)</p>";
                    feedbackHtml += "<p class='player-thought'>ì°¸ê³ : ë‚´ê°€ ë¹µì„ ì‚´ ìˆ˜ ì—†ì„ ê²½ìš°ëŠ” ì•ì‚¬ëŒ ì¤‘ ì ì–´ë„ í•œ ëª…ì´ ë¹µì„ ì‚¬ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. ì´ëŠ” ì „ì²´ í™•ë¥  1ì—ì„œ ë‘ ì‚¬ëŒ ëª¨ë‘ ë¹µì„ ì‚¬ì§€ ì•Šì„ í™•ë¥ (1/4)ì„ ëº€ 3/4 (75%)ì— í•´ë‹¹í•©ë‹ˆë‹¤.</p>";
                    endingText = "[í•˜êµ£ê¸¸, ë¹µì§‘ì—ì„œ ê¸°ëŒ€í•˜ë©° ì¤„ì„ ê¸°ë‹¤ë ¸ì§€ë§Œ, ì•„ì‰½ê²Œë„ ë°”ë¡œ ì•ì—ì„œ ë§ˆì§€ë§‰ ë¹µì´ íŒ”ë ¤ë²„ë ¸ë‹¤.]";
                    effectType = 'bad';
                }
            } else { 
                feedbackHtml = "<h4>ê²°ê³¼: ì§‘ìœ¼ë¡œ...</h4><p>ë‹¹ì‹ ì€ í•˜êµ£ê¸¸ì— ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ì§€ ì•Šê³  ê·¸ëƒ¥ ì§‘ìœ¼ë¡œ ê°€ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.</p>";
                feedbackHtml += "<p class='player-thought'>ê·¸ë ‡ë‹¤ë©´, ë¹µì§‘ì˜ ë§ˆì§€ë§‰ ì´ˆì½” í¬ë¦¼ë¹µì€ ì–´ë–»ê²Œ ë˜ì—ˆì„ê¹Œìš”?</p>";
                let person1Buys = Math.random() < 0.5;
                let person2Buys = Math.random() < 0.5;
                let breadWouldHaveBeenAvailable = true; 
                if (person1Buys) {
                    breadWouldHaveBeenAvailable = false;
                    feedbackHtml += "<p>ì•„ë§ˆë„... ì²« ë²ˆì§¸ ì‚¬ëŒì´ ê·¸ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ê°”ì„ ê²ë‹ˆë‹¤! (ì„ íƒ í™•ë¥  50%)</p>";
                } else {
                    feedbackHtml += "<p>ì•„ë§ˆë„... ì²« ë²ˆì§¸ ì‚¬ëŒì€ ë‹¤ë¥¸ ë¹µì„ ê³¨ëì„ ê±°ê³ ìš”. (ë‹¤ë¥¸ ë¹µ ì„ íƒ í™•ë¥  50%)</p>";
                    if (person2Buys) {
                        breadWouldHaveBeenAvailable = false;
                        feedbackHtml += "<p>ê·¸ë ‡ë‹¤ë©´ ë‘ ë²ˆì§¸ ì‚¬ëŒì´ ê·¸ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ê°”ì„ ê²ë‹ˆë‹¤! (ì„ íƒ í™•ë¥  50%)</p>";
                    } else {
                        feedbackHtml += "<p>ë‘ ë²ˆì§¸ ì‚¬ëŒë„ ë‹¤ë¥¸ ë¹µì„ ê³¨ëì„ ê°€ëŠ¥ì„±ì´ ë†’ë„¤ìš”! (ë‹¤ë¥¸ ë¹µ ì„ íƒ í™•ë¥  50%)</p>";
                    }
                }
                if (breadWouldHaveBeenAvailable) {
                    feedbackHtml += "<p>ë§Œì•½ ì¤„ì„ ê³„ì† ì„°ë‹¤ë©´, ë‹¹ì‹  ì°¨ë¡€ê¹Œì§€ ë¹µì´ ë‚¨ì•„ìˆì—ˆì„ í™•ë¥ (25%)ì´ í˜„ì‹¤ì´ ë˜ì—ˆì„ ìˆ˜ë„ ìˆê² ë„¤ìš”!</p>";
                     feedbackHtml += "<p class='player-thought'>ì°¸ê³ : ë‚´ê°€ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚´ ìˆ˜ ìˆì—ˆë˜ ê²½ìš°ëŠ” ì²« ë²ˆì§¸ ì‚¬ëŒì´ ë‹¤ë¥¸ ë¹µì„ ì‚¬ê³ (1/2 í™•ë¥ ), ë‘ ë²ˆì§¸ ì‚¬ëŒë„ ë‹¤ë¥¸ ë¹µì„ ì‚¬ëŠ” ê²½ìš°(1/2 í™•ë¥ )ì´ë¯€ë¡œ ê·¸ í™•ë¥ ì€ 1/2 Ã— 1/2 = 1/4 (25%)ì…ë‹ˆë‹¤.</p>";
                } else {
                    feedbackHtml += "<p>ë§Œì•½ ì¤„ì„ ê³„ì† ì„°ë”ë¼ë„, ì•ì‚¬ëŒ ì¤‘ ëˆ„êµ°ê°€ê°€ ë¹µì„ ì‚¬ê°”ì„ í™•ë¥ (75%) ë•Œë¬¸ì— ë‹¹ì‹ ì€ ë¹µì„ ì–»ì§€ ëª»í–ˆì„ ê±°ì˜ˆìš”.</p>";
                    feedbackHtml += "<p class='player-thought'>ì°¸ê³ : ë‚´ê°€ ë¹µì„ ì‚´ ìˆ˜ ì—†ì—ˆì„ ê²½ìš°ëŠ” ì•ì‚¬ëŒ ì¤‘ ì ì–´ë„ í•œ ëª…ì´ ë¹µì„ ì‚¬ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. ì´ëŠ” ì „ì²´ í™•ë¥  1ì—ì„œ ë‘ ì‚¬ëŒ ëª¨ë‘ ë¹µì„ ì‚¬ì§€ ì•Šì„ í™•ë¥ (1/4)ì„ ëº€ 3/4 (75%)ì— í•´ë‹¹í•©ë‹ˆë‹¤.</p>";
                }
                endingText = "[í•˜êµ£ê¸¸ ë¹µì§‘ì—ì„œ ì´ˆì½” í¬ë¦¼ë¹µì„ ì‚¬ì§€ ì•Šê³  ì§‘ìœ¼ë¡œ ëŒì•„ì™”ë‹¤. ê·¸ ë¹µì€ ë‹¤ë¥¸ ëˆ„êµ°ê°€ì˜ ì°¨ì§€ê°€ ë˜ì—ˆì„ ê²ƒì´ë‹¤.]";
            }
        }
        else if (screenNum === 6) { 
            const probSumiNotComes = 0.5; 
            const probJieunNotComes = 2/3; 
            const probBothNotCome = probSumiNotComes * probJieunNotComes;

            let sumiActuallyComes = Math.random() < 0.5;
            let jieunActuallyComes = Math.random() < (1/3);

            if (choice === 'A') { 
                playerStats.librarySecretSuccess = !sumiActuallyComes && !jieunActuallyComes;
                feedbackHtml = "<h4>ê²°ê³¼: ë„ì„œê´€ ì ì… ì‹œë„!</h4>";
                feedbackHtml += `<p>ìˆ˜ë¯¸ê°€ ì—†ì„ í™•ë¥ (${probSumiNotComes*100}%) Ã— ì§€ì€ì´ê°€ ì—†ì„ í™•ë¥ (${Math.round(probJieunNotComes*1000)/10}%) = ë‘˜ ë‹¤ ì—†ì„ í™•ë¥  ì•½ <span class="highlight">${Math.round(probBothNotCome*1000)/10}%</span></p>`;
                feedbackHtml += "<hr><p>ì‹¤ì œ ë„ì„œê´€ ìƒí™©ì€...</p>";

                if (playerStats.librarySecretSuccess) {
                    feedbackHtml += "<p>ğŸ‰ **ì ì… ì„±ê³µ!** ğŸ‰ ë‹¤í–‰íˆ ìˆ˜ë¯¸ë„ ì§€ì€ì´ë„ ë„ì„œê´€ì— ì—†ì—ˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ í‰í™”ë¡­ê²Œ ë„ì„œê´€ì„ ì´ìš©í–ˆìŠµë‹ˆë‹¤!</p>";
                    endingText = "[í•˜êµ£ê¸¸, ì¹œêµ¬ë“¤ ëª°ë˜ ë„ì„œê´€ì— ê°”ëŠ”ë° ì•„ë¬´ë„ ë§ˆì£¼ì¹˜ì§€ ì•Šê³  ì¡°ìš©íˆ ì‹œê°„ì„ ë³´ë‚¼ ìˆ˜ ìˆì—ˆë‹¤.]";
                    effectType = 'good';
                } else {
                    feedbackHtml += "<p>ì•„ë¿”ì‹¸! ì ì… ì‹¤íŒ¨!</p>";
                    if (sumiActuallyComes && jieunActuallyComes) {
                        feedbackHtml += "<p>ìˆ˜ë¯¸ì™€ ì§€ì€ì´ ë‘˜ ë‹¤ ë„ì„œê´€ì— ìˆì—ˆìŠµë‹ˆë‹¤! ê²°êµ­ ë§ˆì£¼ì¹˜ê³  ë§ì•˜ë„¤ìš”.</p>";
                        endingText = "[í•˜êµ£ê¸¸, ì¹œêµ¬ë“¤ ëª°ë˜ ë„ì„œê´€ì— ê°”ì§€ë§Œ ê²°êµ­ ìˆ˜ë¯¸ì™€ ì§€ì€ì´ ë‘˜ ë‹¤ ë§ˆì£¼ì¹˜ê³  ë§ì•˜ë‹¤.]";
                    } else if (sumiActuallyComes) {
                        feedbackHtml += "<p>ìˆ˜ë¯¸ê°€ ë„ì„œê´€ì— ìˆì—ˆìŠµë‹ˆë‹¤! ê²°êµ­ ìˆ˜ë¯¸ì™€ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤.</p>";
                        endingText = "[í•˜êµ£ê¸¸, ì¹œêµ¬ë“¤ ëª°ë˜ ë„ì„œê´€ì— ê°”ì§€ë§Œ ê²°êµ­ ìˆ˜ë¯¸ì™€ ë§ˆì£¼ì¹˜ê³  ë§ì•˜ë‹¤.]";
                    } else { 
                        feedbackHtml += "<p>ì§€ì€ì´ê°€ ë„ì„œê´€ì— ìˆì—ˆìŠµë‹ˆë‹¤! ê²°êµ­ ì§€ì€ì´ì™€ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤.</p>";
                        endingText = "[í•˜êµ£ê¸¸, ì¹œêµ¬ë“¤ ëª°ë˜ ë„ì„œê´€ì— ê°”ì§€ë§Œ ê²°êµ­ ì§€ì€ì´ì™€ ë§ˆì£¼ì¹˜ê³  ë§ì•˜ë‹¤.]";
                    }
                    effectType = 'bad';
                }
            } else { 
                playerStats.librarySecretSuccess = null; 
                let secretVisitWouldHaveSucceeded = !sumiActuallyComes && !jieunActuallyComes; 

                feedbackHtml = "<h4>ê²°ê³¼: ì§‘ìœ¼ë¡œ...</h4><p>ë‹¹ì‹ ì€ í•˜êµ£ê¸¸ì— ë„ì„œê´€ì— ë“¤ë¥´ì§€ ì•Šê³  ë°”ë¡œ ì§‘ìœ¼ë¡œ ê°€ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.</p>";
                feedbackHtml += "<p class='player-thought'>ë§Œì•½ ë„ì„œê´€ì— ëª°ë˜ ê°”ë‹¤ë©´ ì–´ë• ì„ê¹Œìš”?</p>";
                feedbackHtml += `<p>ìˆ˜ë¯¸ê°€ ì—†ì„ í™•ë¥ (${probSumiNotComes*100}%) Ã— ì§€ì€ì´ê°€ ì—†ì„ í™•ë¥ (${Math.round(probJieunNotComes*1000)/10}%) = ë‘˜ ë‹¤ ì—†ì„ í™•ë¥  ì•½ <span class="highlight">${Math.round(probBothNotCome*1000)/10}%</span></p>`;
                feedbackHtml += "<hr><p>ì‹¤ì œ (ë‹¹ì‹ ì´ ì•ˆ ê°„) ë„ì„œê´€ ìƒí™© ì¶”ì¸¡...</p>";

                if (secretVisitWouldHaveSucceeded) {
                    feedbackHtml += "<p>ì•„ë§ˆë„... ìˆ˜ë¯¸ë„ ì§€ì€ì´ë„ ì—†ì–´ì„œ ì¡°ìš©íˆ ì´ìš©í•  ìˆ˜ ìˆì—ˆì„ ê±°ì˜ˆìš”! (ë‹¹ì‹ ì´ ê°”ë‹¤ë©´ ì ì… ì„±ê³µ)</p>";
                } else {
                    feedbackHtml += "<p>ì•„ë§ˆë„... ";
                    if (sumiActuallyComes && jieunActuallyComes) {
                        feedbackHtml += "ìˆ˜ë¯¸ì™€ ì§€ì€ì´ ë‘˜ ë‹¤ ìˆì–´ì„œ ë§ˆì£¼ì³¤ì„ ê°€ëŠ¥ì„±ì´ ë†’ì•˜ê² ë„¤ìš”.";
                    } else if (sumiActuallyComes) {
                        feedbackHtml += "ìˆ˜ë¯¸ê°€ ìˆì–´ì„œ ë§ˆì£¼ì³¤ì„ ê±°ì˜ˆìš”.";
                    } else { 
                        feedbackHtml += "ì§€ì€ì´ê°€ ìˆì–´ì„œ ë§ˆì£¼ì³¤ì„ ê±°ì˜ˆìš”.";
                    }
                    feedbackHtml += " ì•ˆ ê°€ê¸¸ ì˜í•œ ê±¸ê¹Œìš”? (ë‹¹ì‹ ì´ ê°”ë‹¤ë©´ ì ì… ì‹¤íŒ¨)</p>";
                }
                endingText = "[í•˜êµ£ê¸¸, ë„ì„œê´€ì— ë“¤ë¥´ì§€ ì•Šê³  ë°”ë¡œ ì§‘ìœ¼ë¡œ ì™”ë‹¤. ê·¸ê³³ì—ì„œ ì¹œêµ¬ë“¤ê³¼ ë§ˆì£¼ì³¤ì„ì§€ ì•„ë‹ì§€ëŠ” ëª¨ë¥´ëŠ” ì¼ì´ë‹¤.]";
            }
        }

        if (endingText) endingTexts.push(endingText);
        
        if (effectType) { 
            triggerEffect(effectType);
        }

        if (screenNum !== 2) { 
            displayImmediateFeedback(screenNum, feedbackHtml, showMainNextBtn);
        }
    }

    function proceedToNext(prevScreenNum) {
        const feedbackDiv = document.getElementById('feedback' + prevScreenNum);
        const nextButton = document.getElementById('nextBtn' + prevScreenNum);
        if(feedbackDiv) feedbackDiv.innerHTML = "";
        if(nextButton) nextButton.style.display = 'none';
        
        if (prevScreenNum === 2) {
            const initialChoices2 = document.getElementById('choices2_initial');
            if (initialChoices2) {
                initialChoices2.style.display = 'block'; 
                initialChoices2.querySelectorAll('button').forEach(button => {
                    button.disabled = false; 
                });
            }
        } else {
            disableChoiceButtons('screen' + prevScreenNum, false);
        }

        currentScreenNum++;
        if (currentScreenNum > 6) {
            displayEnding();
        } else {
            showScreen(currentScreenNum);
            updateMoneyDisplay();
            disableChoiceButtons(currentScreenNum, false);
            if (currentScreenNum === 2) {
                 const initialChoices2 = document.getElementById('choices2_initial');
                 if (initialChoices2) initialChoices2.style.display = 'block';
                 disableChoiceButtons('screen2', false);
            }
        }
    }

    function displayEnding() {
        showScreen('Ending');
        const endingOutput = document.getElementById('endingTextOutput');
        let fullEndingText = "<p><strong>ë‚˜ì˜ ì„ íƒë“¤ì´ ëª¨ì—¬ ì´ëŸ° í•˜ë£¨ê°€ ë˜ì—ˆì–´ìš”...</strong></p>";
        endingTexts.forEach(text => {
            fullEndingText += `<p>${text}</p>`;
        });

        if (playerStats.lotteryAttempts > 0) {
            if (playerStats.lotteryPrize) {
                fullEndingText += `<p>[ë½‘ê¸° ìš”ì•½: ì´ ${playerStats.lotterySpent}ì›ì„ ì‚¬ìš©í•˜ì—¬ ${playerStats.lotteryAttempts}ë²ˆì˜ ë„ì „ ëì— <span class="highlight">10%</span>ì˜ í™•ë¥ ì„ ëš«ê³  ìƒí’ˆì„ ì–»ì—ˆë‹¤!]</p>`;
            } else {
                fullEndingText += `<p>[ë½‘ê¸° ìš”ì•½: ì´ ${playerStats.lotterySpent}ì›ì„ ì‚¬ìš©í•˜ê³  ${playerStats.lotteryAttempts}ë²ˆ ë„ì „í–ˆì§€ë§Œ, ì•„ì‰½ê²Œë„ <span class="highlight">10%</span>ì˜ í™•ë¥  ì•ì—ì„œ ìƒí’ˆì„ ì–»ì§€ ëª»í–ˆë‹¤.]</p>`;
            }
        } else if (document.getElementById('screen2') && !document.getElementById('screen2').classList.contains('active') && currentScreenNum > 2 && !endingTexts.find(txt => txt.includes("ë½‘ê¸° í™•ë¥  ì•ì—ì„œ ë„ì „ì„ í¬ê¸°"))) {
             if(money < 100 && playerStats.lotteryAttempts === 0 && !playerStats.lotteryPrize && !endingTexts.find(txt => txt.includes("ë„ì „ì„ í¬ê¸°í•˜ê³  ëˆì„ ì•„ê¼ˆë‹¤."))) { 
                fullEndingText += "<p>[ë½‘ê¸°: (ë“±êµ£ê¸¸) ëˆì´ ë¶€ì¡±í•˜ì—¬ ì‹œë„ì¡°ì°¨ í•˜ì§€ ëª»í–ˆë‹¤.]</p>";
             }
        }


        fullEndingText += "<hr><p><strong>[í•˜ë£¨ ìš”ì•½ ë° ìƒíƒœ]</strong></p>";
        fullEndingText += `<p>ìµœì¢… ì†Œì§€ê¸ˆ: ${money}ì›</p>`;
        if(playerStats.hasUmbrella) fullEndingText += "<p>- ì±™ê²¨ê°„ ìš°ì‚°ì´ ìˆì—ˆë‹¤.</p>";
        if(playerStats.gotChocoBread) fullEndingText += "<p>- ë§›ìˆëŠ” ì´ˆì½” í¬ë¦¼ë¹µì„ ë¨¹ì—ˆë‹¤!</p>";
        if(playerStats.latePenalty) fullEndingText += "<p>- ì§€ê°ìœ¼ë¡œ ì„ ìƒë‹˜ê»˜ ê¾¸ì¤‘ì„ ë“¤ì—ˆë‹¤.</p>";
        
        const screen4Element = document.getElementById('screen4');
        if (screen4Element && !screen4Element.classList.contains('active') && currentScreenNum > 4) { 
            if(playerStats.quizCorrect) fullEndingText += "<p>- ì‹œí—˜ì—ì„œ ì°ì€ ë¬¸ì œê°€ ì •ë‹µì´ì—ˆë‹¤!</p>";
            else fullEndingText += "<p>- ì‹œí—˜ì—ì„œ ì°ì€ ë¬¸ì œëŠ” í‹€ë ¸ë‹¤.</p>";
        }
        if (playerStats.librarySecretSuccess === true) {
            fullEndingText += "<p>- ë„ì„œê´€ ì ì…ì— ì„±ê³µí•˜ì—¬ ì¡°ìš©íˆ ì‹œê°„ì„ ë³´ëƒˆë‹¤.</p>";
        } else if (playerStats.librarySecretSuccess === false) {
            fullEndingText += "<p>- ë„ì„œê´€ ì ì…ì— ì‹¤íŒ¨í•˜ì—¬ ì¹œêµ¬(ë“¤)ì™€ ë§ˆì£¼ì³¤ë‹¤.</p>";
        }


        endingOutput.innerHTML = fullEndingText;
    }

    function restartGame() {
        currentScreenNum = 1;
        money = 1000;
        endingTexts = [];
        playerStats = {
            hasUmbrella: false,
            lotteryPrize: false,
            lotteryAttempts: 0,
            lotterySpent: 0,
            gotChocoBread: false,
            latePenalty: false,
            quizCorrect: false,
            librarySecretSuccess: null
        };
        initializeGame(); 
    }

    // Ensure this is called after the DOM is loaded or place the script at the end of the body
    window.onload = initializeGame; 
</script>

</body>
</html>